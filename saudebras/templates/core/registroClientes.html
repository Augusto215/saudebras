{%extends 'core/base.html'%}
{%load static%}
{%block 'conteudo'%}
<div class="container d-flex" style="flex-grow:1;">
    <div class="div-parte1 w-100">
<form id="regForm"  method="post" action="{% url 'registerCliente'  %}">
   {% csrf_token %}
   <!-- Campo hidden para armazenar dados do endereço -->
   <input type="hidden" id="enderecoData" name="endereco_data" value="">
   <h3 class="mb-4 text-start" style="color:#00ae9d !important;">Cadastro do Paciente</h3>
   <!-- One "tab" for each step in the form: -->
   <div class="tab">
    <p style="color:#6D6875 !important">Informe seus dados e junte-se a nós para ter acesso a saúde de qualidade a preços acessíveis.</p>

      <p><input  style="border-radius:4px; border: solid 1px #000 !important;" type="text" placeholder="Nome Completo" name="nome" required></p>
      <p><input  style="border-radius:4px; border: solid 1px #000 !important;" type="text" id="cpfId" placeholder="C.P.F" name="username" required></p>
      <p><input  style="border-radius:4px; border: solid 1px #000 !important;" type="email" id="emailId" placeholder="E-mail" name="email" required></p>
      <p><input style="border-radius:4px; border: solid 1px #000 !important;" type="tel" id="phone1" placeholder="Celular/Whatsapp" name="telefone" required></p>
      <p class="my-4 position-relative">
        <select style="border-radius:4px; border: solid 1px #000 !important; padding:10px; outline:none; font-size:17px; color:#767575; -webkit-appearance: none; -moz-appearance: none; appearance: none;" 
                class="w-100" id="genderSelect" name="gender" required>
          <option style="color:#767575 !important;" value="" selected disabled hidden>Gênero</option>
          <option style="color:#767575 !important;" value="male">Masculino</option>
          <option style="color:#767575 !important;" value="female">Feminino</option>
          <option style="color:#767575 !important;" value="other">Outro</option>
        </select>
        <!-- Setinha customizada -->
        <i class="bi bi-chevron-down" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); pointer-events: none; color: #767575; font-size: 14px;"></i>
      </p>
    
   </div>


   <script>
    function maskCPF(cpfField) {
        var cpfValue = cpfField.value;
    
        // Remove tudo o que não é dígito
        cpfValue = cpfValue.replace(/\D/g, '');
        
        // Limita a entrada a exatamente 11 dígitos
        cpfValue = cpfValue.slice(0, 11);
    
        // Aplica a formatação progressivamente
        if (cpfValue.length > 3) {
            cpfValue = cpfValue.replace(/(\d{3})(\d)/, '$1.$2');
        }
        if (cpfValue.length > 6) {
            cpfValue = cpfValue.replace(/(\d{3})\.(\d{3})(\d)/, '$1.$2.$3');
        }
        if (cpfValue.length > 9) {
            cpfValue = cpfValue.replace(/(\d{3})\.(\d{3})\.(\d{3})(\d{1,2})/, '$1.$2.$3-$4');
        }
    
        // Atualiza o valor no campo
        cpfField.value = cpfValue;
    }
    
    function maskTelefone(telefoneField) {
        var telefoneValue = telefoneField.value;
    
        // Remove tudo o que não é dígito
        telefoneValue = telefoneValue.replace(/\D/g, '');
        
        // Limita a entrada a exatamente 11 dígitos
        telefoneValue = telefoneValue.slice(0, 11);
    
        // Aplica a formatação progressivamente baseada no tamanho
        if (telefoneValue.length <= 2) {
            // Apenas DDD: 11
            telefoneValue = telefoneValue;
        } else if (telefoneValue.length <= 7) {
            // DDD + parte do número: (11) 9999
            telefoneValue = telefoneValue.replace(/(\d{2})(\d+)/, '($1) $2');
        } else if (telefoneValue.length <= 10) {
            // Telefone fixo: (11) 9999-9999
            telefoneValue = telefoneValue.replace(/(\d{2})(\d{4})(\d+)/, '($1) $2-$3');
        } else {
            // Celular: (11) 99999-9999
            telefoneValue = telefoneValue.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
        }
    
        // Atualiza o valor no campo
        telefoneField.value = telefoneValue;
    }
</script>
   <div class="tab">
        <div class="endereco-section">
            <h3 class="endereco-main-title">Endereço Residencial</h3>
            
            <!-- Lista de endereços (máximo 1) -->
            <div id="enderecosContainer" class="enderecos-container">
                <div class="endereco-empty-state" id="enderecoEmptyState">
                    <i class="bi bi-house-door"></i>
                    <p>Nenhum endereço adicionado ainda</p>
                    <small>Clique em "Adicionar Endereço" para começar</small>
                </div>
            </div>
            
            <!-- Botão para adicionar endereço -->
            <button type="button" id="addEnderecoBtn" class="btn-endereco-add">
                <i class="bi bi-plus"></i> Adicionar Endereço
            </button>
        </div>

        <!-- Formulário de endereço (oculto inicialmente) -->
        <div id="enderecoForm" class="endereco-form" style="display: none;">
            <h5 id="enderecoFormTitle" class="endereco-form-title">Adicionar Endereço</h5>
            
            <div class="endereco-form-content">
                <div class="form-row">
                    <div class="form-group">
                        <label for="cep">CEP *</label>
                        <input type="text" id="cep" name="cep" class="form-control" placeholder="ex: 00000-000" maxlength="9" required>
                        <div id="cepError" class="error-message" style="display: none;"></div>
                    </div>
                    <div class="form-group">
                        <label for="numero">Número</label>
                        <input type="number" id="numero" name="numero" class="form-control" placeholder="ex: 123">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="rua">Logradouro *</label>
                        <input type="text" id="rua" name="rua" class="form-control" placeholder="Digite o logradouro (rua, avenida, travessa, etc.)" required>
                    </div>
                    <div class="form-group">
                        <label for="complemento">Complemento</label>
                        <input type="text" id="complemento" name="complemento" class="form-control" placeholder="ex: Apto 101, Bloco A, Casa 2">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="bairro">Bairro *</label>
                        <input type="text" id="bairro" name="bairro" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="cidade">Cidade *</label>
                        <input type="text" id="cidade" name="cidade" class="form-control" readonly required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="estado">Estado *</label>
                        <input type="text" id="estado" name="estado" class="form-control" readonly required>
                    </div>
                </div>
                
                <div class="endereco-form-actions">
                    <button type="button" id="cancelarEndereco" class="btn-endereco-cancel">Cancelar</button>
                    <button type="button" id="salvarEndereco" class="btn-endereco-save">
                        <span id="saveEnderecoText">Salvar Endereço</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="tab">
        <span style="color:#6D6875 !important;" class="fw-bold">Foto:</span>
        <p> <input style="border-radius:4px; color:#000; border: solid 1px #000 !important;" type="file" id="inputImage" name="foto" accept="image/*">

        <!-- Modal do Bootstrap para exibir a imagem -->
        <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header d-flex justify-content-center align-items-center">
                <h5 class="modal-title text-center">Visualizar Imagem</h5>
              </div>
              <div class="modal-body d-flex justify-content-center align-items-center">
                <img id="previewImage" src="" style="max-width: 10rem; height:10rem; object-fit:cover; display: none;">
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Salvar</button>
                <button type="button" id="changeButton" class="btn btn-primary">Trocar</button>
              </div>
            </div>
          </div>
        </div>
        
        <script>
            var inputImage = document.getElementById('inputImage');
            var previewImage = document.getElementById('previewImage');
            var imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
            
            inputImage.addEventListener('change', function(e) {
                var files = e.target.files;
                if (files && files.length > 0) {
                    var file = files[0];
                    previewImage.src = URL.createObjectURL(file);
                    previewImage.onload = function() {
                        previewImage.style.display = 'block';
                        imageModal.show(); // Mostra o modal
                    };
                }
            });
            var changeButton = document.getElementById('changeButton');

            changeButton.addEventListener('click', function() {
                inputImage.click(); // Aciona o input de arquivo novamente
            });
        </script>
        
        <h3 class="mb-4 text-start" style="color:#00ae9d !important;">Cadastre sua Senha</h3>
        <ul>
            <li>
                <p style="color:#6D6875 !important; font-size:.9rem !important;">A senha deve conter mínimo de 8 caracteres;</p>
            </li>
            <li>
                <p style="color:#6D6875 !important; font-size:.9rem !important;">Pelo menos um caractere maiúsculo;</p>
            </li>
            <li>
                <p style="color:#6D6875 !important; font-size:.9rem !important;">Pelo menos um número e pelo menos um símbolo.</p>
            </li>
        </ul>   

        <div style="margin-bottom:2.2rem !important;" class="password-field d-flex align-items-center justify-content-center">
            <input style="padding:0 10px; border:none !important; outline:none !important;" type="password" id="password-input" name="password1" placeholder="Digite sua senha">
            <span class="p-2" onclick="togglePasswordVisibility('password-input', 'eye-icon')">
                <i style="font-size:17px !important;" id="eye-icon" class="bi bi-eye-slash"></i>
            </span>
        </div>

        <div style="margin-bottom:2.2rem !important;" class="password-field d-flex align-items-center justify-content-center">
            <input style="padding:0 10px; border:none !important; outline:none !important;" type="password" id="confirm-password-input" name="password2" placeholder="Confirmar Senha">
            <span class="p-2" onclick="togglePasswordVisibility('confirm-password-input', 'confirm-eye-icon')">
                <i style="font-size:17px !important;" id="confirm-eye-icon" class="bi bi-eye-slash"></i>
            </span>
        </div>
    </div>
        
        <script>
            function togglePasswordVisibility(inputId, iconId) {
                var passwordInput = document.getElementById(inputId);
                var eyeIcon = document.getElementById(iconId);
                
                if (passwordInput.type === "password") {
                    passwordInput.type = "text";
                    eyeIcon.classList.remove('bi-eye-slash');
                    eyeIcon.classList.add('bi-eye'); // Ícone de olho aberto
                } else {
                    passwordInput.type = "password";
                    eyeIcon.classList.remove('bi-eye');
                    eyeIcon.classList.add('bi-eye-slash'); // Ícone de olho fechado
                }
            }
        </script>


    



    
 
        
    
    


<div style="overflow:auto;">
    <div style="float:right;">
        <button   type="button" id="prevBtn" style="padding:.7rem 1.3rem !important; border-radius:4px; background:rgb(130 130 130) !important; color:#fff !important; font-weight:600 !important;" onclick="nextPrev(-1)">Voltar</button>
        <button  type="button" id="nextBtn" style="padding:.7rem 1.3rem !important; border-radius:4px; background:#00ae9d !important; color:#fff !important; font-weight:600 !important;" onclick="nextPrev(1)">Próximo</button>
    </div>
</div>

      <!-- Circles which indicates the steps of the form: -->
      <div style="text-align:center;margin-top:40px;">
         <span class="step"></span>
         <span class="step"></span>
         <span class="step"></span>
   
      </div>
</form>
</div>

</div>

<div class="container d-none justify-content-center mt-4 mb-4">
    <div id="carouselExampleControls" class="carousel slide" data-ride="carousel">
        <div class="carousel-inner">
            {% for banner in banners %}
            <div class="carousel-item {% if forloop.first %}active{% endif %}">
                <img style="height:10rem !important; width:20rem!important; object-fit:cover !important;" src="{{ banner.foto.url }}" alt="{{ banner.nome }}">
            </div>
            {% endfor %}
        </div>
        <a class="carousel-control-prev" href="#carouselExampleControls" role="button" data-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="sr-only">Previous</span>
        </a>
        <a class="carousel-control-next" href="#carouselExampleControls" role="button" data-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="sr-only">Next</span>
        </a>
    </div>
    </div>
    <script>
    
        const carouselInner = document.querySelector('.carousel-inner');
        images.forEach((image, index) => {
            const isActive = index === 0 ? 'active' : '';
        
        });
                    </script>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>

<script>
   var currentTab = 0; // Current tab is set to be the first tab (0)
   showTab(currentTab); // Display the current tab
   
   function showTab(n) {
   // This function will display the specified tab of the form...
   var x = document.getElementsByClassName("tab");
   x[n].style.display = "block";
   //... and fix the Previous/Next buttons:
   if (n == 0) {
   document.getElementById("prevBtn").style.display = "none";
   } else {
   document.getElementById("prevBtn").style.display = "inline";
   }
   if (n == (x.length - 1)) {
   document.getElementById("nextBtn").innerHTML = "Enviar";
   } else {
   document.getElementById("nextBtn").innerHTML = "Próximo";
   }
   //... and run a function that will display the correct step indicator:
   fixStepIndicator(n)
   }
   
   function nextPrev(n) {
   // This function will figure out which tab to display
   var x = document.getElementsByClassName("tab");
   // Exit the function if any field in the current tab is invalid:
   if (n == 1 && !validateForm()) return false;
   
   // Se está saindo da aba de endereços (tab 1), atualizar campo hidden
   if (n == 1 && currentTab == 1) {
       prepararDadosEndereco();
   }
   
   // Hide the current tab:
   x[currentTab].style.display = "none";
   // Increase or decrease the current tab by 1:
   currentTab = currentTab + n;
   // if you have reached the end of the form...
   if (currentTab >= x.length) {
   // Preparar dados do endereço antes do submit
   prepararDadosEndereco();
   // ... the form gets submitted:
   document.getElementById("regForm").submit();
   return false;
   }
   // Otherwise, display the correct tab:
   showTab(currentTab);
   }
   
   function validateForm() {
   // This function deals with validation of the form fields
   var x, y, i, valid = true;
   x = document.getElementsByClassName("tab");
   y = x[currentTab].getElementsByTagName("input");
   
   // Validações específicas para a primeira aba (nome, CPF, email e telefone)
   if (currentTab == 0) {
       var nomeInput = document.querySelector('input[name="nome"]');
       var cpfInput = document.querySelector('input[name="username"]');
       var emailInput = document.querySelector('input[name="email"]');
       var telefoneInput = document.querySelector('input[name="telefone"]');
       
       // Validação do nome
       if (nomeInput && nomeInput.value.trim() === "") {
           showNomeVazioModal();
           return false;
       }
       
       // Validação do CPF
       if (cpfInput) {
           // Tentar múltiplas formas de obter o valor do CPF
           var cpfValue1 = cpfInput.value;
           var cpfValue2 = document.getElementById('cpfId').value;
           var cpfValue3 = document.querySelector('#cpfId').value;
           
           // Usar o valor que não estiver vazio
           var cpfValue = cpfValue1 || cpfValue2 || cpfValue3;
           cpfValue = cpfValue.replace(/\D/g, ''); // Remove formatação
           
           // Verifica se CPF tem pelo menos algum dígito
           if (cpfValue.length === 0) {
               showCpfInvalidoModal("Por favor, digite o CPF.");
               return false;
           }
           
           // Verifica se CPF está incompleto
           if (cpfValue.length < 11) {
               showCpfInvalidoModal("CPF incompleto! Digite os 11 dígitos.");
               return false;
           }
           
           // Verifica se CPF tem mais de 11 dígitos
           if (cpfValue.length > 11) {
               showCpfInvalidoModal("CPF inválido! Deve ter exatamente 11 dígitos.");
               return false;
           }
           
           // Validação de CPF
           if (!validarCPF(cpfValue)) {
               showCpfInvalidoModal("CPF inválido! Verifique os números digitados.");
               return false;
           }
           
           // Verificar se CPF já existe no banco (via AJAX)
           var cpfExistenteResult = verificarCpfExistente(cpfValue);
           if (!cpfExistenteResult) {
               return false;
           }
       }
       
       // Validação do Email
       if (emailInput) {
           var emailValue = emailInput.value.trim();
           
           // Verifica se email está vazio
           if (emailValue === "") {
               showEmailInvalidoModal("Por favor, digite seu email.");
               return false;
           }
           
           // Verifica se email tem formato válido
           var emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
           if (!emailRegex.test(emailValue)) {
               showEmailInvalidoModal("Formato de email inválido. Use: nome@email.com");
               return false;
           }
       }
       
       // Validação do Celular
       if (telefoneInput) {
           var telefoneValue = telefoneInput.value.replace(/\D/g, ''); // Remove formatação
           
           // Verifica se telefone está vazio
           if (telefoneValue === "") {
               showCelularInvalidoModal("Por favor, digite seu número de celular.");
               return false;
           }
           
           // Verifica se telefone tem pelo menos 10 dígitos (DDD + número)
           if (telefoneValue.length < 10) {
               showCelularInvalidoModal("Número muito curto. Digite DDD + número (mínimo 10 dígitos).");
               return false;
           }
           
           // Verifica se telefone tem mais de 11 dígitos
           if (telefoneValue.length > 11) {
               showCelularInvalidoModal("Número muito longo. Digite apenas DDD + número (máximo 11 dígitos).");
               return false;
           }
           
           // Verifica se o DDD é válido (entre 11 e 99)
           var ddd = parseInt(telefoneValue.substr(0, 2));
           if (ddd < 11 || ddd > 99) {
               showCelularInvalidoModal("DDD inválido. Digite um DDD válido (11 a 99).");
               return false;
           }
       }
       
       // Validação do Gênero
       var genderSelect = document.querySelector('select[name="gender"]');
       if (genderSelect) {
           if (genderSelect.value === "" || genderSelect.value === null) {
               showGeneroVazioModal();
               return false;
           }
       }
   }
   
   // Verificar campos obrigatórios (validação original)
   // IMPORTANTE: Para a aba de endereços (currentTab == 1), pular esta validação
   if (currentTab !== 1) {
       for (i = 0; i < y.length; i++) {
           // If a field is empty...
           if (y[i].value == "") {
               // add an "invalid" class to the field:
               y[i].className += " invalid";
               // and set the current valid status to false
               valid = false;
           }
       }
   }
   
   // Validação da tab de endereços
   if (currentTab == 1) { // Tab de endereços (segunda aba)
       // Garantir que o formulário de endereço está oculto para não interferir na validação
       const enderecoForm = document.getElementById('enderecoForm');
       if (enderecoForm && enderecoForm.style.display !== 'none') {
           enderecoForm.style.display = 'none';
       }
       
       // Verificar se pelo menos um endereço foi adicionado
       if (enderecoCadastro.length === 0) {
           // Mostrar modal pedindo para adicionar pelo menos um endereço
           showEnderecoObrigatorioModal();
           return false;
       }
   }
   
   // If the valid status is true, mark the step as finished and valid:
   if (valid) {
   document.getElementsByClassName("step")[currentTab].className += " finish";
   }
   return valid; // return the valid status
   }
   
   function fixStepIndicator(n) {
   // This function removes the "active" class of all steps...
   var i, x = document.getElementsByClassName("step");
   for (i = 0; i < x.length; i++) {
   x[i].className = x[i].className.replace(" active", "");
   }
   //... and adds the "active" class on the current step:
   x[n].className += " active";
   }

   document.addEventListener("DOMContentLoaded", function() {
    var checkboxes = document.querySelectorAll("input[type='checkbox'][name='especialidades[]']");
    checkboxes.forEach(function(checkbox) {
        checkbox.addEventListener("click", function() {
            // Forçar que a caixa de seleção permaneça marcada ou desmarcada como desejado
            this.checked = !this.checked ? false : true;
        });
    });
});

// Função de validação de CPF
function validarCPF(cpf) {
    // Remove caracteres não numéricos
    cpf = cpf.replace(/[^\d]+/g, '');
    
    // Verifica se tem 11 dígitos
    if (cpf.length !== 11) {
        return false;
    }
    
    // Verifica se todos os dígitos são iguais (ex: 111.111.111-11)
    if (/^(\d)\1{10}$/.test(cpf)) {
        return false;
    }
    
    // Calcula primeiro dígito verificador
    var soma = 0;
    for (var i = 0; i < 9; i++) {
        soma += parseInt(cpf.charAt(i)) * (10 - i);
    }
    var resto = soma % 11;
    var digito1 = (resto < 2) ? 0 : 11 - resto;
    
    if (parseInt(cpf.charAt(9)) !== digito1) {
        return false;
    }
    
    // Calcula segundo dígito verificador
    soma = 0;
    for (var i = 0; i < 10; i++) {
        soma += parseInt(cpf.charAt(i)) * (11 - i);
    }
    resto = soma % 11;
    var digito2 = (resto < 2) ? 0 : 11 - resto;
    
    return parseInt(cpf.charAt(10)) === digito2;
}

// Função para verificar se CPF já existe no banco de dados
function verificarCpfExistente(cpf) {
    try {
        var xhr = new XMLHttpRequest();
        var formData = new FormData();
        formData.append('cpf', cpf);
        formData.append('action', 'verificar_cpf');
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        xhr.open('POST', window.location.href, false); // Requisição síncrona
        xhr.send(formData);
        
        if (xhr.status === 200) {
            var response = JSON.parse(xhr.responseText);
            if (response.cpf_exists) {
                showCpfExistenteModal();
                return false;
            }
            return true;
        }
    } catch (error) {
        console.error('Erro ao verificar CPF:', error);
        // Em caso de erro na requisição, permitir continuar
        return true;
    }
    
    return true;
}

// Funções para exibir as modais
function showNomeVazioModal() {
    var modal = new bootstrap.Modal(document.getElementById('nomeVazioModal'));
    modal.show();
}

function showCpfInvalidoModal(message) {
    document.getElementById('cpfErrorMessage').textContent = message;
    var modal = new bootstrap.Modal(document.getElementById('cpfInvalidoModal'));
    modal.show();
}

function showCpfExistenteModal() {
    var modal = new bootstrap.Modal(document.getElementById('cpfExistenteModal'));
    modal.show();
}

function showEmailInvalidoModal(message) {
    document.getElementById('emailErrorMessage').textContent = message;
    var modal = new bootstrap.Modal(document.getElementById('emailInvalidoModal'));
    modal.show();
}

function showCelularInvalidoModal(message) {
    document.getElementById('celularErrorMessage').textContent = message;
    var modal = new bootstrap.Modal(document.getElementById('celularInvalidoModal'));
    modal.show();
}

function showGeneroVazioModal() {
    var modal = new bootstrap.Modal(document.getElementById('generoVazioModal'));
    modal.show();
}

function showEnderecoObrigatorioModal() {
    var modal = new bootstrap.Modal(document.getElementById('enderecoObrigatorioModal'));
    modal.show();
}

// Funções para fechar as modais
function fecharModalNomeVazio() {
    var modalElement = document.getElementById('nomeVazioModal');
    var modal = bootstrap.Modal.getInstance(modalElement);
    if (modal) {
        modal.hide();
    }
}

function fecharModalCpfInvalido() {
    var modalElement = document.getElementById('cpfInvalidoModal');
    var modal = bootstrap.Modal.getInstance(modalElement);
    if (modal) {
        modal.hide();
    }
}

function fecharModalCpfExistente() {
    var modalElement = document.getElementById('cpfExistenteModal');
    var modal = bootstrap.Modal.getInstance(modalElement);
    if (modal) {
        modal.hide();
    }
}

// Função específica para fechar a modal do Email
function fecharModalEmailInvalido() {
    var modalElement = document.getElementById('emailInvalidoModal');
    
    // Método 1: Bootstrap 5
    try {
        var modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) {
            modal.hide();
        } else {
            var newModal = new bootstrap.Modal(modalElement);
            newModal.hide();
        }
    } catch (e) {
        console.log('Erro Bootstrap 5:', e);
    }
    
    // Método 2: jQuery (fallback)
    try {
        if (typeof $ !== 'undefined') {
            $('#emailInvalidoModal').modal('hide');
        }
    } catch (e) {
        console.log('Erro jQuery:', e);
    }
    
    // Método 3: Manual (último recurso)
    setTimeout(function() {
        modalElement.style.display = 'none';
        modalElement.classList.remove('show');
        modalElement.setAttribute('aria-hidden', 'true');
        
        // Remover backdrop
        var backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) {
            backdrop.remove();
        }
        
        // Restaurar body
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
        
        // Focar no campo email
        var emailInput = document.querySelector('input[name="email"]');
        if (emailInput) {
            emailInput.focus();
            emailInput.select();
        }
    }, 100);
}

// Função específica para fechar a modal do Celular
function fecharModalCelularInvalido() {
    var modalElement = document.getElementById('celularInvalidoModal');
    
    // Método 1: Bootstrap 5
    try {
        var modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) {
            modal.hide();
        } else {
            var newModal = new bootstrap.Modal(modalElement);
            newModal.hide();
        }
    } catch (e) {
        console.log('Erro Bootstrap 5:', e);
    }
    
    // Método 2: jQuery (fallback)
    try {
        if (typeof $ !== 'undefined') {
            $('#celularInvalidoModal').modal('hide');
        }
    } catch (e) {
        console.log('Erro jQuery:', e);
    }
    
    // Método 3: Manual (último recurso)
    setTimeout(function() {
        modalElement.style.display = 'none';
        modalElement.classList.remove('show');
        modalElement.setAttribute('aria-hidden', 'true');
        
        // Remover backdrop
        var backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) {
            backdrop.remove();
        }
        
        // Restaurar body
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
        
        // Focar no campo telefone
        var telefoneInput = document.querySelector('input[name="telefone"]');
        if (telefoneInput) {
            telefoneInput.focus();
            telefoneInput.select();
        }
    }, 100);
}

// Função específica para fechar a modal do Gênero
function fecharModalGeneroVazio() {
    var modalElement = document.getElementById('generoVazioModal');
    
    // Método 1: Bootstrap 5
    try {
        var modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) {
            modal.hide();
        } else {
            var newModal = new bootstrap.Modal(modalElement);
            newModal.hide();
        }
    } catch (e) {
        console.log('Erro Bootstrap 5:', e);
    }
    
    // Método 2: jQuery (fallback)
    try {
        if (typeof $ !== 'undefined') {
            $('#generoVazioModal').modal('hide');
        }
    } catch (e) {
        console.log('Erro jQuery:', e);
    }
    
    // Método 3: Manual (último recurso)
    setTimeout(function() {
        modalElement.style.display = 'none';
        modalElement.classList.remove('show');
        modalElement.setAttribute('aria-hidden', 'true');
        
        // Remover backdrop
        var backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) {
            backdrop.remove();
        }
        
        // Restaurar body
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
        
        // Focar no campo select de gênero
        var genderSelect = document.querySelector('select[name="gender"]');
        if (genderSelect) {
            genderSelect.focus();
        }
    }, 100);
}

// Remover classe invalid quando começar a digitar
document.addEventListener('input', function(e) {
    if (e.target.tagName === 'INPUT') {
        e.target.className = e.target.className.replace(" invalid", "");
    }
});

// Aplicar máscaras e event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Aplicar máscara ao CPF
    var cpfField = document.getElementById('cpfId');
    if (cpfField) {
        cpfField.addEventListener('input', function() {
            maskCPF(this);
        });
    }
    
    // Aplicar máscara ao telefone
    var telefoneField = document.getElementById('phone1');
    if (telefoneField) {
        telefoneField.addEventListener('input', function() {
            maskTelefone(this);
        });
    }
    
    // ===== GERENCIAMENTO DE ENDEREÇOS =====
    initEnderecoManagement();
    
    // Adicionar funcionalidade de seleção automática para todos os inputs
    var inputs = document.querySelectorAll('input[type="text"], input[type="email"], input[type="tel"], input[type="password"], textarea');
    inputs.forEach(function(input) {
        input.addEventListener('click', function() {
            this.select();
        });
        
        input.addEventListener('focus', function() {
            this.select();
        });
    });
});

// ===== VARIÁVEIS GLOBAIS PARA ENDEREÇOS =====
let enderecoCadastro = []; // Array para armazenar endereços (máximo 1)
let editandoEnderecoId = null; // ID do endereço sendo editado

// ===== FUNÇÕES DE GERENCIAMENTO DE ENDEREÇOS =====

function initEnderecoManagement() {
    const addEnderecoBtn = document.getElementById('addEnderecoBtn');
    const enderecoForm = document.getElementById('enderecoForm');
    const cancelarEndereco = document.getElementById('cancelarEndereco');
    const salvarEndereco = document.getElementById('salvarEndereco');
    const cepInput = document.getElementById('cep');
    
    if (!addEnderecoBtn) return; // Se não estiver na página de endereços, sair
    
    // Máscara para CEP
    if (cepInput) {
        cepInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            value = value.replace(/^(\d{5})(\d)/, '$1-$2');
            e.target.value = value;
            
            // Se CEP completo, buscar endereço
            if (value.length === 9) {
                buscarEnderecoPorCEP(value);
            } else {
                limparCamposEndereco();
            }
        });
        
        // Validação em tempo real
        cepInput.addEventListener('blur', function() {
            validarCampoEndereco(this);
        });
    }
    
    // Event listeners para os botões
    if (addEnderecoBtn) {
        addEnderecoBtn.addEventListener('click', function() {
            // Verificar se já tem 1 endereço (limite para clientes)
            if (enderecoCadastro.length >= 1) {
                alert('Você já adicionou um endereço. Para pacientes é permitido apenas um endereço.');
                return;
            }
            mostrarFormularioEndereco('Adicionar Endereço');
        });
    }
    
    if (cancelarEndereco) {
        cancelarEndereco.addEventListener('click', function() {
            esconderFormularioEndereco();
        });
    }
    
    if (salvarEndereco) {
        salvarEndereco.addEventListener('click', function() {
            salvarEnderecoNoArray();
        });
    }
    
    // Validação em tempo real para outros campos
    const campos = ['rua', 'bairro'];
    campos.forEach(function(campo) {
        const input = document.getElementById(campo);
        if (input) {
            input.addEventListener('blur', function() {
                validarCampoEndereco(this);
            });
        }
    });
}

function validarCampoEndereco(campo) {
    const valor = campo.value.trim();
    const isRequired = campo.hasAttribute('required');
    
    if (isRequired && valor === '') {
        campo.classList.add('invalid');
        campo.classList.remove('valid');
        return false;
    } else if (valor !== '') {
        campo.classList.remove('invalid');
        campo.classList.add('valid');
        return true;
    } else {
        campo.classList.remove('invalid', 'valid');
        return true;
    }
}

function buscarEnderecoPorCEP(cep) {
    const cepInput = document.getElementById('cep');
    const cidadeInput = document.getElementById('cidade');
    const estadoInput = document.getElementById('estado');
    const ruaInput = document.getElementById('rua');
    const bairroInput = document.getElementById('bairro');
    const cepError = document.getElementById('cepError');
    
    // Limpar mensagem de erro anterior
    if (cepError) {
        cepError.style.display = 'none';
    }
    
    // Remover formatação do CEP
    const cepLimpo = cep.replace(/\D/g, '');
    
    if (cepLimpo.length !== 8) {
        return;
    }
    
    // Adicionar indicador de loading
    if (cepInput) {
        cepInput.classList.add('loading');
    }
    
    fetch(`https://viacep.com.br/ws/${cepLimpo}/json/`)
        .then(response => response.json())
        .then(data => {
            if (cepInput) {
                cepInput.classList.remove('loading');
            }
            
            if (data.erro) {
                if (cepError) {
                    cepError.textContent = 'CEP não encontrado. Verifique o número digitado.';
                    cepError.style.display = 'block';
                }
                return;
            }
            
            // Preencher campos automaticamente
            if (cidadeInput) cidadeInput.value = data.localidade || '';
            if (estadoInput) estadoInput.value = data.uf || '';
            if (ruaInput) ruaInput.value = data.logradouro || '';
            if (bairroInput) bairroInput.value = data.bairro || '';
            
            // Focar no próximo campo (número)
            const numeroInput = document.getElementById('numero');
            if (numeroInput) {
                numeroInput.focus();
            }
        })
        .catch(error => {
            console.error('Erro ao buscar CEP:', error);
            if (cepInput) {
                cepInput.classList.remove('loading');
            }
            if (cepError) {
                cepError.textContent = 'Erro ao buscar CEP. Tente novamente.';
                cepError.style.display = 'block';
            }
        });
}

function limparCamposEndereco() {
    const campos = ['cidade', 'estado', 'rua', 'bairro'];
    campos.forEach(function(campo) {
        const input = document.getElementById(campo);
        if (input && input.readOnly) {
            input.value = '';
        }
    });
}

function mostrarFormularioEndereco(titulo) {
    const enderecoForm = document.getElementById('enderecoForm');
    const formTitle = document.getElementById('enderecoFormTitle');
    
    if (formTitle) {
        formTitle.textContent = titulo;
    }
    
    if (enderecoForm) {
        enderecoForm.style.display = 'block';
        enderecoForm.scrollIntoView({ behavior: 'smooth' });
    }
    
    // Focar no primeiro campo
    const cepInput = document.getElementById('cep');
    if (cepInput) {
        setTimeout(() => cepInput.focus(), 300);
    }
}

function esconderFormularioEndereco() {
    const enderecoForm = document.getElementById('enderecoForm');
    if (enderecoForm) {
        enderecoForm.style.display = 'none';
    }
    limparFormularioEndereco();
}

function limparFormularioEndereco() {
    const campos = ['cep', 'numero', 'rua', 'complemento', 'bairro', 'cidade', 'estado'];
    campos.forEach(function(campo) {
        const input = document.getElementById(campo);
        if (input) {
            input.value = '';
            input.classList.remove('invalid', 'valid');
        }
    });
    
    // Limpar mensagens de erro
    const cepError = document.getElementById('cepError');
    if (cepError) {
        cepError.style.display = 'none';
    }
    
    editandoEnderecoId = null;
}

function salvarEnderecoNoArray() {
    // Validar campos obrigatórios
    const cep = document.getElementById('cep').value.trim();
    const rua = document.getElementById('rua').value.trim();
    const bairro = document.getElementById('bairro').value.trim();
    const cidade = document.getElementById('cidade').value.trim();
    const estado = document.getElementById('estado').value.trim();
    
    // Campos opcionais
    const numero = document.getElementById('numero').value.trim();
    const complemento = document.getElementById('complemento').value.trim();
    
    // Validações
    if (!cep || cep.length < 9) {
        alert('Por favor, digite um CEP válido.');
        document.getElementById('cep').focus();
        return;
    }
    
    if (!rua) {
        alert('Por favor, preencha o logradouro.');
        document.getElementById('rua').focus();
        return;
    }
    
    if (!bairro) {
        alert('Por favor, preencha o bairro.');
        document.getElementById('bairro').focus();
        return;
    }
    
    if (!cidade) {
        alert('Por favor, preencha a cidade.');
        document.getElementById('cidade').focus();
        return;
    }
    
    if (!estado) {
        alert('Por favor, preencha o estado.');
        document.getElementById('estado').focus();
        return;
    }
    
    // Criar objeto do endereço
    const endereco = {
        id: editandoEnderecoId || Date.now(),
        cep: cep,
        rua: rua,
        numero: numero,
        complemento: complemento,
        bairro: bairro,
        cidade: cidade,
        estado: estado
    };
    
    if (editandoEnderecoId) {
        // Editando endereço existente
        const index = enderecoCadastro.findIndex(end => end.id === editandoEnderecoId);
        if (index !== -1) {
            enderecoCadastro[index] = endereco;
        }
    } else {
        // Adicionando novo endereço
        enderecoCadastro.push(endereco);
    }
    
    // Atualizar interface
    atualizarListaEnderecos();
    esconderFormularioEndereco();
}

function atualizarListaEnderecos() {
    const container = document.getElementById('enderecosContainer');
    const emptyState = document.getElementById('enderecoEmptyState');
    const addBtn = document.getElementById('addEnderecoBtn');
    
    if (!container) return;
    
    // Limpar container (exceto empty state)
    const items = container.querySelectorAll('.endereco-item');
    items.forEach(item => item.remove());
    
    if (enderecoCadastro.length === 0) {
        // Mostrar estado vazio
        if (emptyState) {
            emptyState.style.display = 'block';
        }
        if (addBtn) {
            addBtn.style.display = 'flex';
        }
    } else {
        // Esconder estado vazio
        if (emptyState) {
            emptyState.style.display = 'none';
        }
        
        // Mostrar/esconder botão de adicionar (limite de 1 endereço para clientes)
        if (addBtn) {
            addBtn.style.display = enderecoCadastro.length >= 1 ? 'none' : 'flex';
        }
        
        // Criar items dos endereços
        enderecoCadastro.forEach(function(endereco) {
            const enderecoItem = document.createElement('div');
            enderecoItem.className = 'endereco-item';
            enderecoItem.innerHTML = `
                <div class="endereco-info">
                    <h6>${endereco.rua}${endereco.numero ? ', ' + endereco.numero : ''}</h6>
                    <p><strong>CEP:</strong> ${endereco.cep}</p>
                    <p><strong>Bairro:</strong> ${endereco.bairro}</p>
                    <p><strong>Cidade:</strong> ${endereco.cidade} - ${endereco.estado}</p>
                    ${endereco.complemento ? `<p><strong>Complemento:</strong> ${endereco.complemento}</p>` : ''}
                </div>
                <div class="endereco-actions">
                    <button type="button" class="btn-endereco-edit" onclick="editarEnderecoTemp(${endereco.id})">
                        <i class="bi bi-pencil"></i> Editar
                    </button>
                    <button type="button" class="btn-endereco-remove" onclick="removerEnderecoTemp(${endereco.id})">
                        <i class="bi bi-trash"></i> Remover
                    </button>
                </div>
            `;
            
            container.appendChild(enderecoItem);
        });
    }
}

function editarEnderecoTemp(enderecoId) {
    const endereco = enderecoCadastro.find(end => end.id === enderecoId);
    if (!endereco) return;
    
    // Preencher formulário com dados do endereço
    document.getElementById('cep').value = endereco.cep;
    document.getElementById('rua').value = endereco.rua;
    document.getElementById('numero').value = endereco.numero || '';
    document.getElementById('complemento').value = endereco.complemento || '';
    document.getElementById('bairro').value = endereco.bairro;
    document.getElementById('cidade').value = endereco.cidade;
    document.getElementById('estado').value = endereco.estado;
    
    editandoEnderecoId = enderecoId;
    mostrarFormularioEndereco('Editar Endereço');
}

function removerEnderecoTemp(enderecoId) {
    const endereco = enderecoCadastro.find(end => end.id === enderecoId);
    if (!endereco) return;
    
    // Mostrar modal de confirmação
    const modal = new bootstrap.Modal(document.getElementById('confirmDeleteAddressModal'));
    const addressPreview = document.getElementById('addressPreview');
    
    if (addressPreview) {
        addressPreview.innerHTML = `
            <strong>${endereco.rua}${endereco.numero ? ', ' + endereco.numero : ''}</strong><br>
            ${endereco.bairro} - ${endereco.cidade}/${endereco.estado}<br>
            CEP: ${endereco.cep}
            ${endereco.complemento ? '<br>Complemento: ' + endereco.complemento : ''}
        `;
    }
    
    const confirmBtn = document.getElementById('confirmDeleteAddress');
    const cancelBtn = document.getElementById('cancelDeleteAddress');
    
    // Remover event listeners anteriores
    confirmBtn.replaceWith(confirmBtn.cloneNode(true));
    cancelBtn.replaceWith(cancelBtn.cloneNode(true));
    
    // Adicionar novos event listeners
    document.getElementById('confirmDeleteAddress').addEventListener('click', function() {
        // Remover endereço do array
        enderecoCadastro = enderecoCadastro.filter(end => end.id !== enderecoId);
        
        // Atualizar interface
        atualizarListaEnderecos();
        
        // Fechar modal
        modal.hide();
    });
    
    modal.show();
}

function prepararDadosEndereco() {
    const enderecoDataField = document.getElementById('enderecoData');
    if (enderecoDataField && enderecoCadastro.length > 0) {
        // Preparar dados do endereço para envio
        enderecoDataField.value = JSON.stringify(enderecoCadastro[0]); // Apenas o primeiro (único) endereço
    }
}

function fecharModalEnderecoObrigatorio() {
    var modalElement = document.getElementById('enderecoObrigatorioModal');
    
    // Método 1: Bootstrap 5
    try {
        var modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) {
            modal.hide();
        } else {
            var newModal = new bootstrap.Modal(modalElement);
            newModal.hide();
        }
    } catch (e) {
        console.log('Erro Bootstrap:', e);
    }
    
    // Método 2: jQuery (se disponível)
    try {
        if (typeof $ !== 'undefined' && $.fn.modal) {
            $('#enderecoObrigatorioModal').modal('hide');
        }
    } catch (e) {
        console.log('Erro jQuery:', e);
    }
    
    // Método 3: Manual (último recurso)
    setTimeout(function() {
        modalElement.style.display = 'none';
        modalElement.classList.remove('show');
        modalElement.setAttribute('aria-hidden', 'true');
        
        // Remover backdrop
        var backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) {
            backdrop.remove();
        }
        
        // Restaurar body
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
        
        // Focar no botão de adicionar endereço
        var addBtn = document.getElementById('addEnderecoBtn');
        if (addBtn) {
            addBtn.focus();
        }
    }, 100);
}

// Função de validação de Email
function validarEmail(email) {
    var emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
    return emailRegex.test(email.trim());
}

// Função de validação de Telefone
function validarTelefone(telefone) {
    // Remove formatação
    var telefoneValue = telefone.replace(/\D/g, '');
    
    // Verifica se tem entre 10 e 11 dígitos
    if (telefoneValue.length < 10 || telefoneValue.length > 11) {
        return false;
    }
    
    // Verifica se o DDD é válido (entre 11 e 99)
    var ddd = parseInt(telefoneValue.substr(0, 2));
    if (ddd < 11 || ddd > 99) {
        return false;
    }
    
    return true;
}



</script>

<!-- Modais de Erro para Validação -->

<!-- Modal para Gênero não selecionado -->
<div class="modal fade" id="generoVazioModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 15px; border: none; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);">
            <div class="modal-header" style="background: linear-gradient(135deg, #ffc107, #e0a800); color: white; border-radius: 15px 15px 0 0;">
                <h5 class="modal-title text-center w-100">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    Campo Obrigatório
                </h5>
            </div>
            <div class="modal-body text-center" style="padding: 30px;">
                <div style="font-size: 60px; color: #ffc107; margin-bottom: 20px;">
                    <i class="bi bi-gender-ambiguous"></i>
                </div>
                <h6 style="color: #333; margin-bottom: 15px;">Gênero é obrigatório!</h6>
                <p style="color: #666; margin-bottom: 0;">Por favor, selecione seu gênero para continuar.</p>
            </div>
            <div class="modal-footer" style="border: none; justify-content: center;">
                <button type="button" id="btnFecharGeneroModal" class="btn btn-warning" data-bs-dismiss="modal" onclick="fecharModalGeneroVazio()" style="padding: 10px 30px; border-radius: 25px;">
                    Entendi
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Email Inválido -->
<div class="modal fade" id="emailInvalidoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 15px; border: none; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);">
            <div class="modal-header" style="background: linear-gradient(135deg, #ffc107, #e0a800); color: white; border-radius: 15px 15px 0 0;">
                <h5 class="modal-title text-center w-100">
                    <i class="bi bi-envelope-exclamation-fill me-2"></i>
                    Email Inválido
                </h5>
            </div>
            <div class="modal-body text-center" style="padding: 30px;">
                <div style="font-size: 60px; color: #ffc107; margin-bottom: 20px;">
                    <i class="bi bi-envelope-x"></i>
                </div>
                <h6 style="color: #333; margin-bottom: 15px;">Email inválido!</h6>
                <p style="color: #666; margin-bottom: 0;" id="emailErrorMessage">
                    Por favor, digite um email válido.
                </p>
            </div>
            <div class="modal-footer" style="border: none; justify-content: center;">
                <button type="button" class="btn btn-warning" data-bs-dismiss="modal" onclick="fecharModalEmailInvalido()" style="padding: 10px 30px; border-radius: 25px;">
                    Corrigir
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Celular Inválido -->
<div class="modal fade" id="celularInvalidoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 15px; border: none; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);">
            <div class="modal-header" style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; border-radius: 15px 15px 0 0;">
                <h5 class="modal-title text-center w-100">
                    <i class="bi bi-telephone-x-fill me-2"></i>
                    Celular Inválido
                </h5>
            </div>
            <div class="modal-body text-center" style="padding: 30px;">
                <div style="font-size: 60px; color: #dc3545; margin-bottom: 20px;">
                    <i class="bi bi-phone-vibrate"></i>
                </div>
                <h6 style="color: #333; margin-bottom: 15px;">Número de celular inválido!</h6>
                <p style="color: #666; margin-bottom: 0;" id="celularErrorMessage">
                    Por favor, digite um número de celular válido com DDD.
                </p>
            </div>
            <div class="modal-footer" style="border: none; justify-content: center;">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal" onclick="fecharModalCelularInvalido()" style="padding: 10px 30px; border-radius: 25px;">
                    Corrigir
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Nome Vazio -->
<div class="modal fade" id="nomeVazioModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 15px; border: none; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);">
            <div class="modal-header" style="background: linear-gradient(135deg, #ffc107, #e0a800); color: white; border-radius: 15px 15px 0 0;">
                <h5 class="modal-title text-center w-100">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    Campo Obrigatório
                </h5>
            </div>
            <div class="modal-body text-center" style="padding: 30px;">
                <div style="font-size: 60px; color: #ffc107; margin-bottom: 20px;">
                    <i class="bi bi-person-fill-x"></i>
                </div>
                <h6 style="color: #333; margin-bottom: 15px;">Nome completo é obrigatório!</h6>
                <p style="color: #666; margin-bottom: 0;">
                    Por favor, digite seu nome completo para continuar.
                </p>
            </div>
            <div class="modal-footer" style="border: none; justify-content: center;">
                <button type="button" class="btn btn-warning" data-bs-dismiss="modal" onclick="fecharModalNomeVazio()" style="padding: 10px 30px; border-radius: 25px;">
                    Entendi
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para CPF Inválido -->
<div class="modal fade" id="cpfInvalidoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 15px; border: none; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);">
            <div class="modal-header" style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; border-radius: 15px 15px 0 0;">
                <h5 class="modal-title text-center w-100">
                    <i class="bi bi-x-circle-fill me-2"></i>
                    CPF Inválido
                </h5>
            </div>
            <div class="modal-body text-center" style="padding: 30px;">
                <div style="font-size: 60px; color: #dc3545; margin-bottom: 20px;">
                    <i class="bi bi-person-fill-x"></i>
                </div>
                <h6 style="color: #333; margin-bottom: 15px;" id="cpfErrorTitle">CPF inválido!</h6>
                <p style="color: #666; margin-bottom: 0;" id="cpfErrorMessage">
                    Verifique os números digitados.
                </p>
            </div>
            <div class="modal-footer" style="border: none; justify-content: center;">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal" onclick="fecharModalCpfInvalido()" style="padding: 10px 30px; border-radius: 25px;">
                    Corrigir
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para CPF já cadastrado -->
<div class="modal fade" id="cpfExistenteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 15px; border: none; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);">
            <div class="modal-header" style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; border-radius: 15px 15px 0 0;">
                <h5 class="modal-title text-center w-100">
                    <i class="bi bi-person-check-fill me-2"></i>
                    CPF Já Cadastrado
                </h5>
            </div>
            <div class="modal-body text-center" style="padding: 30px;">
                <div style="font-size: 60px; color: #dc3545; margin-bottom: 20px;">
                    <i class="bi bi-person-fill-exclamation"></i>
                </div>
                <h6 style="color: #333; margin-bottom: 15px;">CPF já cadastrado no sistema!</h6>
                <p style="color: #666; margin-bottom: 15px;">
                    Este CPF já possui uma conta em nosso banco de dados.
                </p>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <p style="color: #555; margin: 0; font-size: 14px;">
                        <strong>O que você pode fazer:</strong><br>
                        • Fazer login com este CPF se já tem uma conta<br>
                        • Usar um CPF diferente para criar nova conta<br>
                        • Entrar em contato conosco se acredita que há um erro
                    </p>
                </div>
                <p style="color: #666; margin-bottom: 0; font-size: 13px;">
                    <em>Cada CPF pode ter apenas uma conta no sistema.</em>
                </p>
            </div>
            <div class="modal-footer" style="border: none; justify-content: center;">
                <button type="button" id="btnFecharCpfExistenteModal" class="btn btn-danger" data-bs-dismiss="modal" onclick="fecharModalCpfExistente()" style="padding: 10px 30px; border-radius: 25px;">
                    Entendi
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmação para exclusão de endereço -->
<div class="modal fade" id="confirmDeleteAddressModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 15px; border: none; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);">
            <div class="modal-header" style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; border-radius: 15px 15px 0 0;">
                <h5 class="modal-title text-center w-100">
                    <i class="bi bi-trash-fill me-2"></i>
                    Confirmar Exclusão
                </h5>
            </div>
            <div class="modal-body text-center" style="padding: 30px;">
                <div style="font-size: 60px; color: #dc3545; margin-bottom: 20px;">
                    <i class="bi bi-house-x-fill"></i>
                </div>
                <h6 style="color: #333; margin-bottom: 15px;">Remover este endereço?</h6>
                <p style="color: #666; margin-bottom: 15px;">
                    Esta ação não pode ser desfeita.
                </p>
                <div class="address-preview" id="addressPreview" style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; margin: 15px 0; text-align: left;">
                </div>
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 12px; border-radius: 8px; margin-top: 15px;">
                    <small style="color: #856404;">⚠️ O endereço será removido permanentemente da lista</small>
                </div>
            </div>
            <div class="modal-footer" style="border: none; justify-content: center; gap: 10px;">
                <button type="button" id="cancelDeleteAddress" class="btn btn-secondary" data-bs-dismiss="modal" style="padding: 10px 20px; border-radius: 25px;">
                    Cancelar
                </button>
                <button type="button" id="confirmDeleteAddress" class="btn btn-danger" style="padding: 10px 20px; border-radius: 25px;">
                    Sim, Remover
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Endereço Obrigatório -->
<div class="modal fade" id="enderecoObrigatorioModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 15px; border: none; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);">
            <div class="modal-header" style="background: linear-gradient(135deg, #ffc107, #e0a800); color: white; border-radius: 15px 15px 0 0;">
                <h5 class="modal-title text-center w-100">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    Endereço Obrigatório
                </h5>
            </div>
            <div class="modal-body text-center" style="padding: 30px;">
                <div style="font-size: 60px; color: #ffc107; margin-bottom: 20px;">
                    <i class="bi bi-house-plus-fill"></i>
                </div>
                <h6 style="color: #333; margin-bottom: 15px;">Adicione seu endereço!</h6>
                <p style="color: #666; margin-bottom: 0;">
                    É necessário informar seu endereço residencial para continuar o cadastro.
                </p>
            </div>
            <div class="modal-footer" style="border: none; justify-content: center;">
                <button type="button" id="btnFecharEnderecoObrigatorioModal" class="btn btn-warning" data-bs-dismiss="modal" onclick="fecharModalEnderecoObrigatorio()" style="padding: 10px 30px; border-radius: 25px;">
                    Adicionar Endereço
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.invalid {
    border: 2px solid red !important;
    background-color: #ffe6e6 !important;
    animation: shake 0.5s ease-in-out;
}

/* Animação de shake para campos inválidos */
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}

/* Estilo para campos válidos */
.valid {
    border: 2px solid #28a745 !important;
    background-color: #f8fff9 !important;
}

/* Estilos para as modais de erro */
.modal-content {
    animation: modalFadeIn 0.3s ease-out;
}

@keyframes modalFadeIn {
    from {
        opacity: 0;
        transform: scale(0.8) translateY(-50px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

/* ===== ESTILOS PARA SEÇÃO DE ENDEREÇOS ===== */

/* Container principal da seção de endereços */
.endereco-section {
    padding: 0;
    background: transparent;
    margin-bottom: 20px;
}

.endereco-main-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 20px;
    border-bottom: 2px solid #00ae9d;
    padding-bottom: 10px;
}

/* Container dos endereços */
.enderecos-container {
    margin-bottom: 20px;
}

/* Estado vazio */
.endereco-empty-state {
    text-align: center;
    padding: 40px 20px;
    background: #f8f9fa;
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    color: #6c757d;
}

.endereco-empty-state i {
    font-size: 3rem;
    margin-bottom: 15px;
    display: block;
    color: #dee2e6;
}

.endereco-empty-state p {
    margin: 8px 0 4px 0;
    font-weight: 600;
    font-size: 1.1rem;
    color: #495057;
}

.endereco-empty-state small {
    color: #6c757d;
    font-size: 0.9rem;
}

/* Item de endereço na lista - Baseado na imagem */
.endereco-item {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 20px;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    margin-bottom: 15px;
    background: #f8f9fa;
    transition: all 0.2s ease;
}

.endereco-item:hover {
    background: #f1f3f4;
    border-color: #ced4da;
}

.endereco-info {
    flex: 1;
    padding-right: 15px;
}

.endereco-info h6 {
    margin: 0 0 8px 0;
    color: #212529;
    font-weight: 600;
    font-size: 1.1rem;
}

.endereco-info p {
    margin: 4px 0;
    color: #495057;
    font-size: 0.9rem;
    line-height: 1.4;
}

.endereco-actions {
    display: flex;
    gap: 8px;
    flex-shrink: 0;
}

/* Botões de ação nos endereços - Cores da imagem */
.btn-endereco-edit, .btn-endereco-remove {
    padding: 2px 8px;
    font-size: 0.75rem;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 3px;
    font-weight: 500;
}

.btn-endereco-edit {
    background: #6c757d !important;
    color: #fff;
}

.btn-endereco-edit:hover {
    background: #5a6268 !important;
    transform: translateY(-1px);
}

.btn-endereco-remove {
    background: #dc3545 !important;
    color: #fff;
}

.btn-endereco-remove:hover {
    background: #c82333 !important;
    transform: translateY(-1px);
}

/* Botão para adicionar endereço - Verde da imagem */
.btn-endereco-add {
    background: #28a745;
    color: #fff;
    border: none;
    padding: 12px 24px;
    border-radius: 6px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 0 auto;
}

.btn-endereco-add:hover {
    background: #218838;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
}

/* Formulário de endereço */
.endereco-form {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 24px;
    margin-top: 20px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.endereco-form-title {
    font-size: 1.3rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 2px solid #00ae9d;
}

.endereco-form-content .form-row {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
}

.endereco-form-content .form-group {
    flex: 1;
}

.endereco-form-content .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #374151;
    font-size: 0.95rem;
}

.endereco-form-content .form-control {
    width: 100%;
    padding: 12px 16px !important;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.2s ease;
    background: #fff;
}

.endereco-form-content .form-control:focus {
    outline: none;
    border-color: #00ae9d;
    box-shadow: 0 0 0 3px rgba(0, 174, 157, 0.1);
}

.endereco-form-content .form-control[readonly] {
    background-color: #f9fafb;
    color: #6b7280;
    cursor: not-allowed;
}

.endereco-form-content .form-control.loading {
    background-image: url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="%23d1d5db" stroke-width="4"/><path d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z" fill="%2300ae9d"/></svg>');
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 20px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Ações do formulário de endereço */
.endereco-form-actions {
    display: flex;
    gap: 15px;
    justify-content: flex-end;
    margin-top: 24px;
    padding-top: 20px;
    border-top: 1px solid #e5e7eb;
}

.btn-endereco-cancel, .btn-endereco-save {
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.95rem;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 6px;
}

.btn-endereco-cancel {
    background: #6b7280 !important;
    color: #fff;
}

.btn-endereco-cancel:hover {
    background: #4b5563 !important;
}

.btn-endereco-save {
    background: linear-gradient(135deg, #00ae9d, #008e7a) !important;
    color: #fff;
}

.btn-endereco-save:hover {
    background: linear-gradient(135deg, #008e7a, #00756b) !important;
    transform: translateY(-1px);
}

/* Mensagens de erro */
.error-message {
    color: #dc2626;
    font-size: 0.85rem;
    margin-top: 6px;
    display: flex;
    align-items: center;
    gap: 4px;
}

.error-message::before {
    content: "⚠️";
}

/* Responsividade */
@media (max-width: 768px) {
    .endereco-form-content .form-row {
        flex-direction: column;
        gap: 15px;
    }
    
    .endereco-item {
        flex-direction: column;
        gap: 15px;
    }
    
    .endereco-actions {
        align-self: stretch;
        justify-content: center;
    }
    
    .endereco-form-actions {
        flex-direction: column;
    }
    
    .btn-endereco-cancel, .btn-endereco-save {
        width: 100%;
        justify-content: center;
    }
}

.tab {
    display: none;
}

.tab:first-child {
    display: block;
}
</style>

<!-- Arquivo form.js temporariamente removido para evitar conflitos -->
<!-- <script src="{%static 'js/form.js' %}"> </script> -->
{%endblock%}