{%extends 'core/base.html'%}
{%load static%}
{%block 'conteudo'%}
<div class="container d-flex" style="flex-grow:1;">
    <div class="div-parte1 w-100">
<form id="regForm"  method="post" action="{% url 'registerCliente'  %}">
   {% csrf_token %}
   <h3 class="mb-4 text-start" style="color:#00ae9d !important;">Cadastro do Paciente</h3>
   <!-- One "tab" for each step in the form: -->
   <div class="tab">
    <p style="color:#6D6875 !important">Informe seus dados e junte-se a nós para ter acesso a saúde de qualidade a preços acessíveis.</p>

      <p><input  style="border-radius:4px; border: solid 1px #000 !important;" type="text" placeholder="Nome Completo" oninput="this.className = ''" name="nome"></p>
      <p><input  style="border-radius:4px; border: solid 1px #000 !important;" type="text" id="cpfId" placeholder="C.P.F" oninput="maskCPF(this)" oninput="this.className = ''" name="username"></p>
      <p><input  style="border-radius:4px; border: solid 1px #000 !important;" type="email" id="emailId" placeholder="E-mail" oninput="this.className = ''" name="email"></p>
      <p><input style="border-radius:4px; border: solid 1px #000 !important;" type="tel"   id="phone1" placeholder="Celular/Whatsapp" oninput="this.className = ''" name="telefone"></p>
      <p class="my-4">
        <select style="border-radius:4px; border: solid 1px #000 !important; padding:10px; outline:none; font-size:17px; color:#767575; -webkit-appearance: none; -moz-appearance: none; appearance: none;" 
                class="w-100" id="genderSelect" name="gender">
          <option style="color:#767575 !important;" value="" selected disabled hidden>Gênero</option>
          <option style="color:#767575 !important;" value="male">Masculino</option>
          <option style="color:#767575 !important;" value="female">Feminino</option>
        </select>
      </p>

      <div style="display: flex; align-items: center; gap: 2rem;">
        <input class="d-flex justify-content-center text-center" type="text" placeholder="DDD" name="ddd" maxlength="2"
               style="border-radius: 4px; border: solid 1px #000; padding: 10px; font-size: 17px; width: 60px; margin-right: 10px;">
        <input type="tel" placeholder="Celular/Whatsapp" name="telefone" 
               pattern="[0-9]{4,5}-[0-9]{4}" maxlength="10"
               style="border-radius: 4px; border: solid 1px #000; padding: 10px; font-size: 17px; flex: 1;">
      </div>
    
   </div>


   <script>
    function maskCPF(cpfField) {
        var cpfValue = cpfField.value;
    
        // Remove tudo o que não é dígito
        cpfValue = cpfValue.replace(/\D/g, '');
        
        // Limita a entrada a exatamente 11 dígitos
        cpfValue = cpfValue.slice(0, 11);
    
        // Aplica a formatação progressivamente
        if (cpfValue.length > 3) {
            cpfValue = cpfValue.replace(/(\d{3})(\d)/, '$1.$2');
        }
        if (cpfValue.length > 6) {
            cpfValue = cpfValue.replace(/(\d{3})\.(\d{3})(\d)/, '$1.$2.$3');
        }
        if (cpfValue.length > 9) {
            cpfValue = cpfValue.replace(/(\d{3})\.(\d{3})\.(\d{3})(\d{1,2})/, '$1.$2.$3-$4');
        }
    
        // Atualiza o valor no campo
        cpfField.value = cpfValue;
    }
</script>
   <div class="tab">
    
      
    <p><input style="border-radius:4px; border: solid 1px #000 !important;" type="text" id="cep" placeholder="CEP" oninput="buscarCEP(this.value)" name="cep"></p>
    <p><input style="border-radius:4px; border: solid 1px #000 !important;" type="text" id="cidade" placeholder="Cidade"></p>
    <p><input style="border-radius:4px; border: solid 1px #000 !important;" type="text" id="logradouro" placeholder="Logradouro"></p>
    <p><input style="border-radius:4px; border: solid 1px #000 !important;" type="text" id="bairro" placeholder="Bairro"></p>
    <p><input style="border-radius:4px; border: solid 1px #000 !important;" type="text" id="complemento" placeholder="Complemento"></p>

    <script>
        function buscarCEP(cep) {
            cep = cep.replace(/\D/g, ''); // Remove caracteres não numéricos
            if (cep.length === 8) { // Verifica se o CEP tem 8 dígitos
                fetch(`https://viacep.com.br/ws/${cep}/json/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.erro) {
                            alert('CEP não encontrado.');
                            return;
                        }
                        document.getElementById('cidade').value = data.localidade;
                        document.getElementById('logradouro').value = data.logradouro;
                        document.getElementById('bairro').value = data.bairro; // Adiciona o bairro
                        document.getElementById('complemento').value = data.complemento;
                    })
                    .catch(error => console.error('Erro ao buscar o CEP:', error));
            }
        }
    </script>
        <script>
            function aplicaMascaraCEP(input) {
              let valor = input.value;
              
              // Remove tudo o que não é dígito
              valor = valor.replace(/\D/g, '');
              
              // Adiciona o hífen antes do último grupo de 3 dígitos
              valor = valor.replace(/^(\d{5})(\d)/, '$1-$2');
              
              // Limita o input a 9 caracteres
              valor = valor.substring(0, 9);
              
              input.value = valor;
            }
            </script>
    <span   style="color:#6D6875 !important;"  class="fw-bold">Foto:</span>
    <p> <input style="border-radius:4px; color:#000; border: solid 1px #000 !important;" type="file" id="inputImage" name="foto" accept="image/*">

        <!-- Modal do Bootstrap para exibir a imagem -->
        <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header d-flex justify-content-center align-items-center">
                <h5 class="modal-title text-center">Visualizar Imagem</h5>
              </div>
              <div class="modal-body d-flex justify-content-center align-items-center">
                <img id="previewImage" src="" style="max-width: 10rem; height:10rem; object-fit:cover; display: none;">
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Salvar</button>
                <button type="button" id="changeButton" class="btn btn-primary">Trocar</button>

              </div>
            </div>
          </div>
        </div>
        
        <script>
            var inputImage = document.getElementById('inputImage');
            var previewImage = document.getElementById('previewImage');
            var imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
            
            inputImage.addEventListener('change', function(e) {
                var files = e.target.files;
                if (files && files.length > 0) {
                    var file = files[0];
                    previewImage.src = URL.createObjectURL(file);
                    previewImage.onload = function() {
                        previewImage.style.display = 'block';
                        imageModal.show(); // Mostra o modal
                    };
                }
            });
            var changeButton = document.getElementById('changeButton');

            changeButton.addEventListener('click', function() {
                inputImage.click(); // Aciona o input de arquivo novamente
            });
            </script>
        
        
        <h3 class="mb-4 text-start" style="color:#00ae9d !important;">Cadastre sua Senha</h3>
        <ul>
            <li>
                <p style="color:#6D6875 !important; font-size:.9rem !important;">A senha deve conter mínimo de 8 caracteres;</p>

            </li>
            <li>
                <p style="color:#6D6875 !important; font-size:.9rem !important;">Pelo menos um caractere maiúsculo;</p>

            </li>
            <li>
                <p style="color:#6D6875 !important; font-size:.9rem !important;">Pelo menos um número e pelo menos um símbolo.</p>

            </li>

        </ul>   


       
          
 <div style="margin-bottom:2.2rem !important;" class="password-field d-flex align-items-center justify-content-center">
            <input style="padding:0 10px; border:none !important; outline:none !important;" type="password" id="password-input" name="password1" placeholder="Digite sua senha">
            <span class="p-2" onclick="togglePasswordVisibility('password-input', 'eye-icon')">
                <i style="font-size:17px !important;    " id="eye-icon" class="bi bi-eye-slash"></i>
            </span>
        </div>


        <div style="margin-bottom:2.2rem !important;" class="password-field d-flex align-items-center justify-content-center">
            <input style="padding:0 10px; border:none !important; outline:none !important;" type="password" id="confirm-password-input" name="password2" placeholder="Confirmar Senha">
            <span class="p-2" onclick="togglePasswordVisibility('confirm-password-input', 'confirm-eye-icon')">
                <i style="font-size:17px !important;    " id="confirm-eye-icon" class="bi bi-eye-slash"></i>
            </span>
        </div>

    </div>
        
        <script>
            function togglePasswordVisibility(inputId, iconId) {
                var passwordInput = document.getElementById(inputId);
                var eyeIcon = document.getElementById(iconId);
                
                if (passwordInput.type === "password") {
                    passwordInput.type = "text";
                    eyeIcon.classList.remove('bi-eye-slash');
                    eyeIcon.classList.add('bi-eye'); // Ícone de olho aberto
                } else {
                    passwordInput.type = "password";
                    eyeIcon.classList.remove('bi-eye');
                    eyeIcon.classList.add('bi-eye-slash'); // Ícone de olho fechado
                }
            }
        </script>


    



    
 
        
    
    


<div style="overflow:auto;">
    <div style="float:right;">
        <button   type="button" id="prevBtn" style="padding:.7rem 1.3rem !important; border-radius:4px; background:rgb(130 130 130) !important; color:#fff !important; font-weight:600 !important;" onclick="nextPrev(-1)">Voltar</button>
        <button  type="button" id="nextBtn" style="padding:.7rem 1.3rem !important; border-radius:4px; background:#00ae9d !important; color:#fff !important; font-weight:600 !important;" onclick="nextPrev(1)">Próximo</button>
    </div>
</div>

      <!-- Circles which indicates the steps of the form: -->
      <div style="text-align:center;margin-top:40px;">
         <span class="step"></span>
         <span class="step"></span>
         <span class="step"></span>
   
      </div>
</form>
</div>

</div>

<div class="container d-none justify-content-center mt-4 mb-4">
    <div id="carouselExampleControls" class="carousel slide" data-ride="carousel">
        <div class="carousel-inner">
            {% for banner in banners %}
            <div class="carousel-item {% if forloop.first %}active{% endif %}">
                <img style="height:10rem !important; width:20rem!important; object-fit:cover !important;" src="{{ banner.foto.url }}" alt="{{ banner.nome }}">
            </div>
            {% endfor %}
        </div>
        <a class="carousel-control-prev" href="#carouselExampleControls" role="button" data-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="sr-only">Previous</span>
        </a>
        <a class="carousel-control-next" href="#carouselExampleControls" role="button" data-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="sr-only">Next</span>
        </a>
    </div>
    </div>
    <script>
    
        const carouselInner = document.querySelector('.carousel-inner');
        images.forEach((image, index) => {
            const isActive = index === 0 ? 'active' : '';
        
        });
                    </script>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>

<script>
   var currentTab = 0; // Current tab is set to be the first tab (0)
   showTab(currentTab); // Display the current tab
   
   function showTab(n) {
   // This function will display the specified tab of the form...
   var x = document.getElementsByClassName("tab");
   x[n].style.display = "block";
   //... and fix the Previous/Next buttons:
   if (n == 0) {
   document.getElementById("prevBtn").style.display = "none";
   } else {
   document.getElementById("prevBtn").style.display = "inline";
   }
   if (n == (x.length - 1)) {
   document.getElementById("nextBtn").innerHTML = "Enviar";
   } else {
   document.getElementById("nextBtn").innerHTML = "Próximo";
   }
   //... and run a function that will display the correct step indicator:
   fixStepIndicator(n)
   }
   
   function nextPrev(n) {
   // This function will figure out which tab to display
   var x = document.getElementsByClassName("tab");
   // Exit the function if any field in the current tab is invalid:
   if (n == 1 && !validateForm()) return false;
   // Hide the current tab:
   x[currentTab].style.display = "none";
   // Increase or decrease the current tab by 1:
   currentTab = currentTab + n;
   // if you have reached the end of the form...
   if (currentTab >= x.length) {
   // ... the form gets submitted:
   document.getElementById("regForm").submit();
   return false;
   }
   // Otherwise, display the correct tab:
   showTab(currentTab);
   }
   
   function validateForm() {
   // This function deals with validation of the form fields
   var x, y, i, valid = true;
   x = document.getElementsByClassName("tab");
   y = x[currentTab].getElementsByTagName("input");
   
   // Validações específicas para a primeira aba (nome e CPF)
   if (currentTab == 0) {
       var nomeInput = document.querySelector('input[name="nome"]');
       var cpfInput = document.querySelector('input[name="username"]');
       
       // Validação do nome
       if (nomeInput && nomeInput.value.trim() === "") {
           showNomeVazioModal();
           return false;
       }
       
       // Validação do CPF
       if (cpfInput) {
           // Tentar múltiplas formas de obter o valor do CPF
           var cpfValue1 = cpfInput.value;
           var cpfValue2 = document.getElementById('cpfId').value;
           var cpfValue3 = document.querySelector('#cpfId').value;
           
           // Usar o valor que não estiver vazio
           var cpfValue = cpfValue1 || cpfValue2 || cpfValue3;
           cpfValue = cpfValue.replace(/\D/g, ''); // Remove formatação
           
           // Verifica se CPF tem pelo menos algum dígito
           if (cpfValue.length === 0) {
               showCpfInvalidoModal("Por favor, digite o CPF.");
               return false;
           }
           
           // Verifica se CPF está incompleto
           if (cpfValue.length < 11) {
               showCpfInvalidoModal("CPF incompleto! Digite os 11 dígitos.");
               return false;
           }
           
           // Verifica se CPF tem mais de 11 dígitos
           if (cpfValue.length > 11) {
               showCpfInvalidoModal("CPF inválido! Deve ter exatamente 11 dígitos.");
               return false;
           }
           
           // Validação de CPF
           if (!validarCPF(cpfValue)) {
               showCpfInvalidoModal("CPF inválido! Verifique os números digitados.");
               return false;
           }
           
           // Verificar se CPF já existe no banco (via AJAX)
           return verificarCpfExistente(cpfValue);
       }
   }
   
   // A loop that checks every input field in the current tab:
   for (i = 0; i < y.length; i++) {
   // If a field is empty...
   if (y[i].value == "") {
     // add an "invalid" class to the field:
     y[i].className += " invalid";
     // and set the current valid status to false
     valid = false;
   }
   }
   // If the valid status is true, mark the step as finished and valid:
   if (valid) {
   document.getElementsByClassName("step")[currentTab].className += " finish";
   }
   return valid; // return the valid status
   }
   
   function fixStepIndicator(n) {
   // This function removes the "active" class of all steps...
   var i, x = document.getElementsByClassName("step");
   for (i = 0; i < x.length; i++) {
   x[i].className = x[i].className.replace(" active", "");
   }
   //... and adds the "active" class on the current step:
   x[n].className += " active";
   }

   document.addEventListener("DOMContentLoaded", function() {
    var checkboxes = document.querySelectorAll("input[type='checkbox'][name='especialidades[]']");
    checkboxes.forEach(function(checkbox) {
        checkbox.addEventListener("click", function() {
            // Forçar que a caixa de seleção permaneça marcada ou desmarcada como desejado
            this.checked = !this.checked ? false : true;
        });
    });
});

// Função de validação de CPF
function validarCPF(cpf) {
    // Remove caracteres não numéricos
    cpf = cpf.replace(/[^\d]+/g, '');
    
    // Verifica se tem 11 dígitos
    if (cpf.length !== 11) {
        return false;
    }
    
    // Verifica se todos os dígitos são iguais (ex: 111.111.111-11)
    if (/^(\d)\1{10}$/.test(cpf)) {
        return false;
    }
    
    // Calcula primeiro dígito verificador
    var soma = 0;
    for (var i = 0; i < 9; i++) {
        soma += parseInt(cpf.charAt(i)) * (10 - i);
    }
    var resto = soma % 11;
    var digito1 = (resto < 2) ? 0 : 11 - resto;
    
    if (parseInt(cpf.charAt(9)) !== digito1) {
        return false;
    }
    
    // Calcula segundo dígito verificador
    soma = 0;
    for (var i = 0; i < 10; i++) {
        soma += parseInt(cpf.charAt(i)) * (11 - i);
    }
    resto = soma % 11;
    var digito2 = (resto < 2) ? 0 : 11 - resto;
    
    return parseInt(cpf.charAt(10)) === digito2;
}

// Função para verificar se CPF já existe no banco de dados
function verificarCpfExistente(cpf) {
    try {
        var xhr = new XMLHttpRequest();
        var formData = new FormData();
        formData.append('cpf', cpf);
        formData.append('action', 'verificar_cpf');
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        xhr.open('POST', window.location.href, false); // Requisição síncrona
        xhr.send(formData);
        
        if (xhr.status === 200) {
            var response = JSON.parse(xhr.responseText);
            if (response.cpf_exists) {
                showCpfExistenteModal();
                return false;
            }
            return true;
        }
    } catch (error) {
        console.error('Erro ao verificar CPF:', error);
        // Em caso de erro na requisição, permitir continuar
        return true;
    }
    
    return true;
}

// Funções para exibir as modais
function showNomeVazioModal() {
    var modal = new bootstrap.Modal(document.getElementById('nomeVazioModal'));
    modal.show();
}

function showCpfInvalidoModal(message) {
    document.getElementById('cpfErrorMessage').textContent = message;
    var modal = new bootstrap.Modal(document.getElementById('cpfInvalidoModal'));
    modal.show();
}

function showCpfExistenteModal() {
    var modal = new bootstrap.Modal(document.getElementById('cpfExistenteModal'));
    modal.show();
}

// Funções para fechar as modais
function fecharModalNomeVazio() {
    var modalElement = document.getElementById('nomeVazioModal');
    var modal = bootstrap.Modal.getInstance(modalElement);
    if (modal) {
        modal.hide();
    }
}

function fecharModalCpfInvalido() {
    var modalElement = document.getElementById('cpfInvalidoModal');
    var modal = bootstrap.Modal.getInstance(modalElement);
    if (modal) {
        modal.hide();
    }
}

function fecharModalCpfExistente() {
    var modalElement = document.getElementById('cpfExistenteModal');
    var modal = bootstrap.Modal.getInstance(modalElement);
    if (modal) {
        modal.hide();
    }
}

// Remover classe invalid quando começar a digitar
document.addEventListener('input', function(e) {
    if (e.target.tagName === 'INPUT') {
        e.target.className = e.target.className.replace(" invalid", "");
    }
});



</script>

<!-- Modais de Erro para Validação -->

<!-- Modal para Nome Vazio -->
<div class="modal fade" id="nomeVazioModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 15px; border: none; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);">
            <div class="modal-header" style="background: linear-gradient(135deg, #ffc107, #e0a800); color: white; border-radius: 15px 15px 0 0;">
                <h5 class="modal-title text-center w-100">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    Campo Obrigatório
                </h5>
            </div>
            <div class="modal-body text-center" style="padding: 30px;">
                <div style="font-size: 60px; color: #ffc107; margin-bottom: 20px;">
                    <i class="bi bi-person-fill-x"></i>
                </div>
                <h6 style="color: #333; margin-bottom: 15px;">Nome completo é obrigatório!</h6>
                <p style="color: #666; margin-bottom: 0;">
                    Por favor, digite seu nome completo para continuar.
                </p>
            </div>
            <div class="modal-footer" style="border: none; justify-content: center;">
                <button type="button" class="btn btn-warning" data-bs-dismiss="modal" onclick="fecharModalNomeVazio()" style="padding: 10px 30px; border-radius: 25px;">
                    Entendi
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para CPF Inválido -->
<div class="modal fade" id="cpfInvalidoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 15px; border: none; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);">
            <div class="modal-header" style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; border-radius: 15px 15px 0 0;">
                <h5 class="modal-title text-center w-100">
                    <i class="bi bi-x-circle-fill me-2"></i>
                    CPF Inválido
                </h5>
            </div>
            <div class="modal-body text-center" style="padding: 30px;">
                <div style="font-size: 60px; color: #dc3545; margin-bottom: 20px;">
                    <i class="bi bi-person-fill-x"></i>
                </div>
                <h6 style="color: #333; margin-bottom: 15px;" id="cpfErrorTitle">CPF inválido!</h6>
                <p style="color: #666; margin-bottom: 0;" id="cpfErrorMessage">
                    Verifique os números digitados.
                </p>
            </div>
            <div class="modal-footer" style="border: none; justify-content: center;">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal" onclick="fecharModalCpfInvalido()" style="padding: 10px 30px; border-radius: 25px;">
                    Corrigir
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para CPF já cadastrado -->
<div class="modal fade" id="cpfExistenteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 15px; border: none; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);">
            <div class="modal-header" style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; border-radius: 15px 15px 0 0;">
                <h5 class="modal-title text-center w-100">
                    <i class="bi bi-person-check-fill me-2"></i>
                    CPF Já Cadastrado
                </h5>
            </div>
            <div class="modal-body text-center" style="padding: 30px;">
                <div style="font-size: 60px; color: #dc3545; margin-bottom: 20px;">
                    <i class="bi bi-person-fill-exclamation"></i>
                </div>
                <h6 style="color: #333; margin-bottom: 15px;">CPF já cadastrado no sistema!</h6>
                <p style="color: #666; margin-bottom: 15px;">
                    Este CPF já possui uma conta em nosso banco de dados.
                </p>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <p style="color: #555; margin: 0; font-size: 14px;">
                        <strong>O que você pode fazer:</strong><br>
                        • Fazer login com este CPF se já tem uma conta<br>
                        • Usar um CPF diferente para criar nova conta<br>
                        • Entrar em contato conosco se acredita que há um erro
                    </p>
                </div>
                <p style="color: #666; margin-bottom: 0; font-size: 13px;">
                    <em>Cada CPF pode ter apenas uma conta no sistema.</em>
                </p>
            </div>
            <div class="modal-footer" style="border: none; justify-content: center;">
                <button type="button" id="btnFecharCpfExistenteModal" class="btn btn-danger" data-bs-dismiss="modal" onclick="fecharModalCpfExistente()" style="padding: 10px 30px; border-radius: 25px;">
                    Entendi
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.invalid {
    border: 2px solid red !important;
    background-color: #ffe6e6 !important;
    animation: shake 0.5s ease-in-out;
}

/* Animação de shake para campos inválidos */
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}

/* Estilo para campos válidos */
.valid {
    border: 2px solid #28a745 !important;
    background-color: #f8fff9 !important;
}

/* Estilos para as modais de erro */
.modal-content {
    animation: modalFadeIn 0.3s ease-out;
}

@keyframes modalFadeIn {
    from {
        opacity: 0;
        transform: scale(0.8) translateY(-50px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}
</style>

<!-- Arquivo form.js temporariamente removido para evitar conflitos -->
<!-- <script src="{%static 'js/form.js' %}"> </script> -->
{%endblock%}