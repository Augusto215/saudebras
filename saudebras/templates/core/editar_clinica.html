{% extends 'core/base.html' %}
{% load static %}
{% block 'conteudo' %}
<style>
  /* Reset de estilos para inputs */
  .profile-settings-card input,
  .profile-settings-card textarea {
    text-decoration: none !important;
    border-bottom: none !important;
    -webkit-appearance: none !important;
    -moz-appearance: none !important;
    appearance: none !important;
  }
  
  /* Estilos para mensagens de alerta */
  .alert {
    border-radius: 12px;
    border: none;
    padding: 1rem 1.5rem;
    margin-bottom: 1rem;
    font-weight: 500;
  }

  .alert-success {
    background-color: #d1fae5;
    color: #065f46;
    border-left: 4px solid #059669;
  }
  
  .alert-error,
  .alert-danger {
    background-color: #fee2e2;
    color: #991b1b;
    border-left: 4px solid #dc2626;
  }
  
  .alert-info {
    background-color: #dbeafe;
    color: #1e40af;
    border-left: 4px solid #3b82f6;
  }
  
  .alert-warning {
    background-color: #fef3c7;
    color: #92400e;
    border-left: 4px solid #f59e0b;
  }
  
  .btn-close {
    background: none;
    border: none;
    font-size: 1.2rem;
    color: inherit;
    opacity: 0.7;
    cursor: pointer;
  }
  
  .btn-close:hover {
    opacity: 1;
  }
  
  /* Botão verde personalizado */
  .btn-success {
    background: #00ae9d !important;
    color: #fff !important;
    border: none !important;
    border-radius: 8px !important;
    padding: 0.6rem 1.2rem !important;
    font-size: 0.9rem !important;
    cursor: pointer !important;
    transition: background 0.2s !important;
  }
  
  .btn-success:hover:not(:disabled) {
    background: #008e7a !important;
  }
  
  .btn-success:disabled {
    background: #a1a1aa !important;
    cursor: not-allowed !important;
  }
  
  .profile-settings-container {
    background: #f8fafc;
    min-height: 100vh;
    padding: 2rem 0;
  }
  .profile-settings-card {
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 2px 16px 0 rgba(0,0,0,0.08);
    max-width: 1000px;
    margin: 0 auto;
    overflow: hidden;
  }
  .profile-sidebar {
    background: #f8fafc;
    border-right: 1px solid #e2e8f0;
    padding: 2rem 1.5rem;
    min-height: 600px;
    width: 250px;
  }
  .sidebar-nav {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .sidebar-nav li {
    margin-bottom: 0.5rem;
  }
  .sidebar-nav button {
    width: 100%;
    text-align: left;
    background: none;
    border: none;
    padding: 0.8rem 1rem;
    border-radius: 8px;
    color: #64748b;
    font-weight: 500;
    transition: all 0.2s;
    cursor: pointer;
  }
  .sidebar-nav button:hover,
  .sidebar-nav button.active {
    background: #00ae9d;
    color: #fff;
  }
  .profile-content {
    padding: 2.5rem;
    flex: 1;
  }
  .profile-section-title {
    font-size: 1.4rem;
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 2rem;
    border-bottom: 2px solid #00ae9d;
    padding-bottom: 0.5rem;
    display: inline-block;
  }
  .profile-card {
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    position: relative;
    overflow: visible;
  }
  .profile-img-section {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    margin-bottom: 2rem;
  }
  .profile-img-section img {
    border-radius: 50%;
    width: 100px;
    height: 100px;
    object-fit: cover;
    border: 4px solid #e2e8f0;
  }
  .profile-img-section .edit-btn {
    background: #00ae9d;
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 0.6rem 1.2rem;
    font-size: 0.9rem;
    cursor: pointer;
    transition: background 0.2s;
  }
  .profile-img-section .edit-btn:hover {
    background: #008e7a;
  }
  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
  }
  .form-group {
    display: flex;
    flex-direction: column;
  }
  .form-group label {
    font-size: 0.9rem;
    color: #374151;
    margin-bottom: 0.5rem;
    font-weight: 600;
  }
  .form-group input,
  .form-group textarea {
    border: 1px solid #d1d5db !important;
    border-radius: 8px !important;
    padding: 0.8rem 1rem;
    font-size: 1rem;
    background: #f9fafb !important;
    transition: all 0.2s;
    outline: none !important;
    box-shadow: none !important;
    text-decoration: none !important;
    border-bottom: 1px solid #d1d5db !important;
  }
  .form-group input:focus,
  .form-group textarea:focus {
    border-color: #00ae9d !important;
    outline: none !important;
    background: #fff !important;
    box-shadow: 0 0 0 3px rgba(0, 174, 157, 0.1) !important;
    border-bottom: 1px solid #00ae9d !important;
  }
  .btn-primary {
    background: #00ae9d;
    border: none;
    border-radius: 8px;
    color: #fff;
    font-size: 1rem;
    font-weight: 600;
    padding: 0.8rem 2rem;
    cursor: pointer;
    transition: background 0.2s;
    margin-top: 1rem;
  }
  .btn-primary:hover {
    background: #008e7a;
  }
  .btn-secondary {
    background: #6b7280;
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 0.6rem 1.2rem;
    font-size: 0.9rem;
    cursor: pointer;
    transition: background 0.2s;
  }
  .btn-secondary:hover {
    background: #4b5563;
  }
  
  /* Botões menores para ações secundárias */
  .btn-small {
    padding: 0.5rem 1rem !important;
    font-size: 0.9rem !important;
    min-width: auto !important;
  }
  
  /* Botões de adicionar menores */
  #addConvenio, 
  #addIdioma, 
  #addServico {
    padding: 0.5rem 1rem !important;
    font-size: 0.9rem !important;
    min-width: auto !important;
  }
  
  /* Botão de adicionar endereço menor */
  #addEnderecoBtn {
    padding: 0.5rem 1rem !important;
    font-size: 0.9rem !important;
    min-width: auto !important;
  }
  
  /* Botões de ação de endereço menores */
  .endereco-actions .btn-secondary,
  .endereco-actions .btn-danger {
    padding: 0.4rem 0.8rem !important;
    font-size: 0.85rem !important;
    min-width: auto !important;
  }
  
  /* Botões do formulário de endereço menores */
  #cancelarEndereco {
    padding: 0.5rem 1rem !important;
    font-size: 0.9rem !important;
    min-width: auto !important;
  }
  
  /* Botões das abas da sidebar menores */
  .sidebar-nav button {
    padding: 0.7rem 1.2rem !important;
    font-size: 0.9rem !important;
  }
  /* Estilos para tags criadas dinamicamente */
  #conveniosContainer, #idiomasContainer, #servicosContainer {
    min-height: 2rem;
    margin-bottom: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
    position: relative;
    z-index: 1;
  }
  .tag-item {
    display: inline-flex;
    align-items: center;
    background: #e8f4f8;
    border: 1px solid #00ae9d;
    padding: 0.5rem 0.8rem;
    border-radius: 6px;
    font-size: 0.85rem;
    color: #1e293b;
    width: fit-content;
    position: relative;
  }
  .tag-remove {
    background: none !important;
    border: none !important;
    color: #dc2626 !important;
    margin-left: 0.8rem !important;
    cursor: pointer !important;
    font-weight: bold !important;
    font-size: 1.1rem !important;
    line-height: 1 !important;
    padding: 0 !important;
    width: 16px !important;
    height: 16px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }
  
  /* Especificidade máxima para garantir que seja sempre vermelho */
  #conveniosContainer .tag-remove,
  #idiomasContainer .tag-remove,
  #servicosContainer .tag-remove,
  span.tag-item .tag-remove,
  span .tag-remove {
    background: none !important;
    border: none !important;
    color: #dc2626 !important;
    margin-left: 0.8rem !important;
    cursor: pointer !important;
    font-weight: bold !important;
    font-size: 1.1rem !important;
    line-height: 1 !important;
    padding: 0 !important;
    width: 16px !important;
    height: 16px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }
  
  .tag-remove:hover,
  #conveniosContainer .tag-remove:hover,
  #idiomasContainer .tag-remove:hover,
  #servicosContainer .tag-remove:hover,
  span.tag-item .tag-remove:hover,
  span .tag-remove:hover {
    color: #b91c1c !important;
    background: rgba(220, 38, 38, 0.1) !important;
    border-radius: 50% !important;
  }
  /* Estilos para o formulário de adição */
  .add-form-container {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    position: relative;
    z-index: 10;
  }
  .add-form-select {
    appearance: none;
    background: #fff;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    padding: 0.5rem 2rem 0.5rem 0.75rem;
    font-size: 0.9rem;
    color: #374151;
    cursor: pointer;
    min-width: 200px;
    position: relative;
    z-index: 15;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.5rem center;
    background-repeat: no-repeat;
    background-size: 1.5em 1.5em;
  }
  .add-form-select:focus {
    outline: none;
    border-color: #00ae9d;
    box-shadow: 0 0 0 3px rgba(0, 174, 157, 0.1);
    z-index: 20;
  }
  .add-form-button {
    background: #00ae9d;
    color: #fff;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background 0.2s;
    white-space: nowrap;
  }
  .add-form-button:hover {
    background: #008e7a;
  }
  /* Garante que o container principal não esconda o dropdown */
  .profile-settings-container {
    overflow: visible !important;
  }
  .profile-content {
    overflow: visible !important;
  }
  .conteudo {
    display: none;
  }
  .conteudo.active {
    display: block;
  }
  
  /* Estilos para perguntas */
  .question-card {
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    background: #f9fafb;
  }
  
  .question-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
  }
  
  .question-header img {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
  }
  
  .question-content {
    margin-bottom: 1rem;
  }
  
  .answer-form textarea {
    width: 100%;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    padding: 0.75rem;
    resize: vertical;
    min-height: 80px;
  }
  
  .empty-state {
    text-align: center;
    padding: 2rem;
    color: #6b7280;
  }
  
  .empty-state i {
    font-size: 2rem;
    margin-bottom: 1rem;
    display: block;
  }
  
  /* Estilos responsivos */
  @media (max-width: 768px) {
    .profile-settings-card {
      margin: 0 1rem;
      flex-direction: column;
    }
    
    .profile-sidebar {
      width: 100%;
      border-right: none;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .form-row {
      grid-template-columns: 1fr;
    }
    
    .profile-content {
      padding: 1.5rem;
    }
  }
  
  /* Estilos para mensagens de erro */
  .error-message {
    display: block;
    background: #fef2f2;
    border: 1px solid #fca5a5;
    border-radius: 4px;
    padding: 0.5rem;
    margin-top: 0.5rem;
    color: #dc2626 !important;
    font-size: 0.8rem !important;
    font-weight: 500;
    animation: fadeIn 0.3s ease-in;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  /* Estilos para modal de confirmação da foto */
  .confirmation-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1060;
    opacity: 0;
    animation: fadeInOverlay 0.3s ease-out forwards;
  }
  
  .confirmation-modal {
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    max-width: 450px;
    width: 90%;
    max-height: 90vh;
    margin: 2rem;
    overflow: hidden;
    transform: scale(0.9) translateY(20px);
    animation: slideInModal 0.3s ease-out forwards;
  }
  
  .confirmation-modal-header {
    padding: 1.5rem 2rem 1rem 2rem;
    border-bottom: 1px solid #e5e7eb;
  }
  
  .confirmation-modal-header h3 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: #1f2937;
  }
  
  .confirmation-modal-body {
    padding: 1.5rem 2rem;
    text-align: center;
  }
  
  .confirmation-modal-body p {
    margin: 0 0 1.5rem 0;
    color: #6b7280;
    font-size: 1rem;
  }
  
  .preview-section {
    margin: 1rem 0;
  }
  
  .preview-section img {
    border: 2px solid #e5e7eb;
    border-radius: 8px;
  }
  
  .confirmation-modal-footer {
    padding: 1rem 2rem 1.5rem 2rem;
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
  }
  
  .confirmation-modal-footer .btn-secondary {
    background: #6b7280;
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 0.6rem 1.2rem;
    font-size: 0.9rem;
    cursor: pointer;
    transition: background 0.2s;
  }
  
  .confirmation-modal-footer .btn-secondary:hover {
    background: #4b5563;
  }
  
  .confirmation-modal-footer .btn-primary {
    background: #00ae9d;
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 0.6rem 1.2rem;
    font-size: 0.9rem;
    cursor: pointer;
    transition: background 0.2s;
  }
  
  .confirmation-modal-footer .btn-primary:hover {
    background: #008e7a;
  }
  
  /* Estilos para seção de endereços */
  .endereco-item {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 1.5rem;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    margin-bottom: 1rem;
    background: #f9fafb;
    transition: all 0.2s;
  }
  
  .endereco-item:hover {
    border-color: #00ae9d;
    background: #f0fdfa;
  }
  
  .endereco-info h6 {
    margin: 0 0 0.5rem 0;
    color: #1f2937;
    font-weight: 600;
  }
  
  .endereco-info p {
    margin: 0.25rem 0;
    color: #6b7280;
    font-size: 0.9rem;
  }
  
  .endereco-actions {
    display: flex;
    gap: 0.5rem;
    flex-shrink: 0;
  }
  
  .btn-sm {
    padding: 0.4rem 0.8rem;
    font-size: 0.8rem;
    border-radius: 6px;
  }
  
  .btn-danger {
    background: #dc2626;
    color: #fff;
    border: none;
    cursor: pointer;
    transition: background 0.2s;
    border-radius: 6px;
  }
  
  .btn-danger:hover {
    background: #b91c1c;
  }
  
  @keyframes fadeInOverlay {
    to { opacity: 1; }
  }
  
  @keyframes slideInModal {
    to { 
      transform: scale(1) translateY(0);
    }
  }
  
  /* Estilos para formulário de endereços */
  .form-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    margin-top: 1.5rem;
  }
  
  /* Espaçamento melhorado para formulário de endereços */
  #enderecoForm .form-group {
    margin-bottom: 1.5rem;
  }
  
  #enderecoForm .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    margin-left: 0.5rem;
    font-weight: 600;
    color: #374151;
  }
  
  #enderecoForm .form-control {
    padding: 0.75rem 1.5rem;
    padding-left: 1.5rem;
    margin-left: 0.5rem;
    width: calc(100% - 1rem);
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.2s, box-shadow 0.2s;
    text-indent: 0 !important;
  }
  
  #enderecoForm input[type="text"],
  #enderecoForm input[type="number"] {
    padding-left: 1.5rem !important;
    text-indent: 0 !important;
  }
  
  #enderecoForm .form-control:focus {
    outline: none;
    border-color: #00ae9d;
    box-shadow: 0 0 0 3px rgba(0, 174, 157, 0.1);
  }
  
  #enderecoForm .form-control[readonly] {
    background-color: #f9fafb;
    color: #6b7280;
  }
  
  .subscription-info {
    background: #fef3c7;
    border: 1px solid #f59e0b;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1.5rem;
    color: #92400e;
  }
  
  .trial-text {
    font-weight: 600;
    color: #92400e;
    margin-top: 1rem;
  }
</style>
<!-- Modal para editar foto -->
<div class="modal fade" id="editarFoto" tabindex="-1" aria-labelledby="editarFotoLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editarFoto">Editar Foto da Clínica</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="formEditarFoto" enctype="multipart/form-data" method="post" action="{% url 'alterar_Clinica' %}">
          {% csrf_token %}
          <input type="hidden" name="action" value="update_photo">
          <div class="form-group mb-3">
            <label for="inputFoto" class="form-label">Selecionar nova foto</label>
            <input type="file" id="inputFoto" name="foto" class="form-control" accept="image/*" required>
            <div class="form-text text-muted">
              Formatos aceitos: JPG, PNG, GIF. Tamanho máximo: 5MB
            </div>
            <div id="preview-container" class="mt-3" style="display: none;">
              <img id="preview-image" src="" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 8px;">
            </div>
            <div id="error-message" class="text-danger mt-2" style="display: none;"></div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" id="btnSalvarFoto" class="btn-success" disabled>Salvar Foto</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmação para exclusão de endereço -->
<div class="confirmation-modal-overlay" id="confirmDeleteAddressModal" style="display: none;">
  <div class="confirmation-modal">
    <div class="confirmation-modal-header">
      <h3><i class="bi bi-exclamation-triangle text-warning me-2"></i>Confirmar Exclusão</h3>
    </div>
    <div class="confirmation-modal-body">
      <p>Tem certeza que deseja <strong>remover permanentemente</strong> este endereço?</p>
      <div class="address-preview" id="addressPreview">
        <!-- Dados do endereço serão inseridos aqui -->
      </div>
      <div class="alert alert-warning mt-3" style="font-size: 0.9rem;">
        <i class="bi bi-info-circle me-1"></i>
        Esta ação não pode ser desfeita.
      </div>
    </div>
    <div class="confirmation-modal-footer">
      <button type="button" id="cancelDeleteAddress" class="btn-secondary">Cancelar</button>
      <button type="button" id="confirmDeleteAddress" class="btn-danger">
        <i class="bi bi-trash me-1"></i>Remover Endereço
      </button>
    </div>
  </div>
</div>

<div class="profile-settings-container">
  <div class="profile-settings-card d-flex">
    <!-- Sidebar -->
    <div class="profile-sidebar">
      <ul class="sidebar-nav">
        <li><button onclick="alterarConteudo('conteudo1')" class="tab-btn active">Editar Perfil</button></li>
        <li><button onclick="alterarConteudo('conteudo2')" class="tab-btn">Endereços</button></li>
        <li><button onclick="alterarConteudo('conteudo3')" class="tab-btn">Perguntas</button></li>
      </ul>
      
      {% if clinica.is_active == False %}
      <div class="subscription-info">
        <button id="checkout-button" class="btn-primary w-100">Assinar Plano</button>
      </div>
      {% endif %}
      
      {% if has_active_subscription and days_remaining is None %}
      <form method="post" action="{% url 'cancel-subscription' %}" style="display: none; margin: 0;">
        {% csrf_token %}
        <button type="submit" class="btn-secondary w-100 mt-2" style="background: #dc3545;">Cancelar Assinatura</button>
      </form>
      {% endif %}
      
      <a href="{% url 'perfil_clinica' clinica.id %}" class="text-decoration-none">
        <button class="btn-secondary w-100 mt-2">Ver Perfil Público</button>
      </a>
      
      {% if days_remaining is not None %}
      <div class="trial-text" style="margin-top: 1rem; padding: 0.5rem; background: #fef3c7; color: #92400e; border-radius: 6px; text-align: center; font-size: 0.8rem;">
        Dias restantes no período de teste: {{ days_remaining }}
      </div>
      {% endif %}
    </div>

    <!-- Content Area -->
    <div class="profile-content">
      <!-- Conteúdo 1: Editar Perfil -->
      <div id="conteudo1" class="conteudo active">
        <div class="profile-section-title">Configurações da Clínica</div>
        
        <form id="editarPerfil" enctype="multipart/form-data" method="post" action="{% url 'alterar_Clinica' %}">
          {% csrf_token %}
          <input type="hidden" name="action" value="update_profile">
          
          <!-- Seção da foto -->
          <div class="profile-card">
            <h6 class="mb-3">Perfil da Clínica</h6>
            <div class="profile-img-section">
              <img {% if clinica.foto %}src="{{clinica.foto.url}}"{% else %}src="{% static 'img/default-clinic.png' %}"{% endif %} alt="Foto da clínica">
              <div>
                <h5>{{clinica.nome}}</h5>
                <button type="button" class="edit-btn" data-bs-toggle="modal" data-bs-target="#editarFoto">
                  Alterar Imagem
                </button>
              </div>
            </div>
          </div>

          <!-- Informações básicas -->
          <div class="profile-card">
            <h6 class="mb-3">Informações Básicas</h6>
            <div class="form-group">
              <label for="nome">Nome da Clínica</label>
              <input type="text" id="nome" name="nome" value="{{clinica.nome}}" required>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="telefone">Telefone</label>
                <input type="text" id="telefone" name="telefone" value="{{clinica.telefone}}">
              </div>
              <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email" value="{{clinica.email|default:''}}">
              </div>
            </div>
            <div class="form-group">
              <label for="descricao">Descrição da Clínica</label>
              <textarea id="descricao" name="descricao" rows="4" placeholder="Descreva sua clínica, especialidades e serviços oferecidos...">{{clinica.descricao}}</textarea>
            </div>
          </div>

          <!-- Convênios -->
          <div class="profile-card">
            <h6 class="mb-3">Convênios Aceitos</h6>
            <div id="conveniosContainer"></div>
            <button type="button" id="addConvenio" class="btn-secondary">Adicionar Convênio</button>
          </div>

          <!-- Idiomas -->
          <div class="profile-card">
            <h6 class="mb-3">Idiomas</h6>
            <div id="idiomasContainer"></div>
            <button type="button" id="addIdioma" class="btn-secondary">Adicionar Idioma</button>
          </div>

          <!-- Serviços -->
          <div class="profile-card">
            <h6 class="mb-3">Serviços Oferecidos</h6>
            <div id="servicosContainer"></div>
            <button type="button" id="addServico" class="btn-secondary">Adicionar Serviço</button>
          </div>

          <button type="submit" class="btn-primary">Salvar Alterações</button>
        </form>
      </div>

      <!-- Conteúdo 2: Endereços -->
      <div id="conteudo2" class="conteudo">
        <div class="profile-section-title">Endereços</div>
        
        <!-- Lista de endereços existentes -->
        <div class="profile-card">
          <h6 class="mb-3">Endereços da Clínica</h6>
          <div id="enderecosContainer">
            {% for endereco in clinica.enderecos.all %}
            <div class="endereco-item" data-id="{{ endereco.id }}"
                 data-cep="{{ endereco.cep.codigo }}"
                 data-rua="{{ endereco.rua }}"
                 data-numero="{{ endereco.numero|default:'' }}"
                 data-complemento="{{ endereco.complemento|default:'' }}"
                 data-bairro="{{ endereco.bairro.nome }}"
                 data-cidade="{{ endereco.cidade.nome }}"
                 data-estado="{{ endereco.estado.nome }}">
              <div class="endereco-info">
                <h6>{{ endereco.rua }}{% if endereco.numero %}, {{ endereco.numero }}{% endif %}</h6>
                <p>{{ endereco.bairro.nome }}, {{ endereco.cidade.nome }} - {{ endereco.estado.nome }}</p>
                <p>CEP: {{ endereco.cep.codigo }}{% if endereco.complemento %} - {{ endereco.complemento }}{% endif %}</p>
              </div>
              <div class="endereco-actions">
                <button type="button" class="btn-secondary btn-sm" onclick="editarEndereco({{ endereco.id }})">
                  <i class="bi bi-pencil"></i> Editar
                </button>
                <button type="button" class="btn-danger btn-sm" onclick="removerEndereco({{ endereco.id }})">
                  <i class="bi bi-trash"></i> Remover
                </button>
              </div>
            </div>
            {% empty %}
            <div class="empty-state">
              <i class="bi bi-house-door"></i>
              <p>Nenhum endereço cadastrado</p>
            </div>
            {% endfor %}
          </div>
          
          <button type="button" id="addEnderecoBtn" class="btn-primary mt-3">
            <i class="bi bi-plus"></i> Adicionar Endereço
          </button>
        </div>

        <!-- Formulário de endereço (oculto inicialmente) -->
        <div id="enderecoForm" class="profile-card" style="display: none;">
          <h6 id="enderecoFormTitle" class="mb-3">Adicionar Endereço</h6>
          <form id="formEndereco" method="post" action="{% url 'alterar_Clinica' %}">
            {% csrf_token %}
            <input type="hidden" name="action" value="update_address">
            <input type="hidden" id="enderecoId" name="endereco_id" value="">
            
            <div class="form-row">
              <div class="form-group">
                <label for="cep">CEP *</label>
                <input type="text" id="cep" name="cep" class="form-control" placeholder="ex: 00000-000" maxlength="9" required>
                <div id="cepError" class="error-message" style="display: none;"></div>
              </div>
              <div class="form-group">
                <label for="numero">Número</label>
                <input type="number" id="numero" name="numero" class="form-control" placeholder="ex: 123">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="rua">Logradouro *</label>
                <input type="text" id="rua" name="rua" class="form-control" placeholder="Digite o logradouro (rua, avenida, travessa, etc.)" required>
              </div>
              <div class="form-group">
                <label for="complemento">Complemento</label>
                <input type="text" id="complemento" name="complemento" class="form-control" placeholder="ex: Apto 101, Bloco A, Casa 2">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="bairro">Bairro *</label>
                <input type="text" id="bairro" name="bairro" class="form-control" required>
              </div>
              <div class="form-group">
                <label for="cidade">Cidade *</label>
                <input type="text" id="cidade" name="cidade" class="form-control" readonly required>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="estado">Estado *</label>
                <input type="text" id="estado" name="estado" class="form-control" readonly required>
              </div>
            </div>
            
            <div class="form-actions">
              <button type="button" id="cancelarEndereco" style="background: #6b7280 !important;" onmouseover="this.style.background='#4b5563';" onmouseout="this.style.background='#6b7280';" class="btn-primary">Cancelar</button>
              <button type="submit" class="btn-primary">
                <span id="saveEnderecoText">Salvar Endereço</span>
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Conteúdo 3: Perguntas -->
      <div id="conteudo3" class="conteudo">
        <div class="profile-section-title">Perguntas dos Pacientes</div>

        <!-- Perguntas para responder -->
        <div class="profile-card">
          <h6 class="mb-3">Perguntas Aguardando Resposta</h6>
          
          {% for pergunta in clinica.perguntas.all %}
            {% if pergunta.resposta == blank %}
              <div class="question-card">
                <div class="question-header">
                  <img src="{{ pergunta.cliente.foto.url }}" alt="{{ pergunta.cliente.nome }}">
                  <div>
                    <strong>{{ pergunta.cliente.nome }}</strong>
                    <p style="color: #6b7280; margin: 0; font-size: 0.9rem;">{{ pergunta.data_pergunta|date:"d/m/Y H:i" }}</p>
                  </div>
                </div>
                
                <div class="question-content">
                  <p>{{ pergunta.pergunta }}</p>
                </div>
                
                <form method="post" action="{% url 'alterar_Clinica' %}">
                  {% csrf_token %}
                  <input type="hidden" name="pergunta_id" value="{{ pergunta.id }}">
                  <input type="hidden" name="action" value="responder_pergunta">
                  
                  <div class="answer-form">
                    <textarea name="resposta" placeholder="Digite sua resposta..." required></textarea>
                    <button type="submit" class="btn-primary mt-2">
                      <i class="bi bi-reply"></i> Enviar Resposta
                    </button>
                  </div>
                </form>
              </div>
            {% endif %}
          {% empty %}
            <div class="empty-state">
              <i class="bi bi-chat-left-text"></i>
              <p>Nenhuma pergunta pendente no momento</p>
            </div>
          {% endfor %}
        </div>

        <!-- Perguntas respondidas -->
        <div class="profile-card">
          <h6 class="mb-3">Perguntas Respondidas</h6>
          
          <div style="max-height: 400px; overflow-y: auto;">
            {% for pergunta in clinica.perguntas.all %}
              {% if pergunta.resposta != blank %}
                <div class="question-card">
                  <div class="question-header">
                    <img src="{{ pergunta.cliente.foto.url }}" alt="{{ pergunta.cliente.nome }}">
                    <div>
                      <strong>{{ pergunta.cliente.nome }}</strong>
                      <p style="color: #6b7280; margin: 0; font-size: 0.9rem;">{{ pergunta.data_pergunta|date:"d/m/Y H:i" }}</p>
                    </div>
                  </div>
                  
                  <div class="question-content">
                    <p style="color: #000;"><strong>Pergunta:</strong> {{ pergunta.pergunta }}</p>
                    <p style="color: #000;;"><strong>Sua resposta:</strong> {{ pergunta.resposta }}</p>
                  </div>
                </div>
              {% endif %}
            {% empty %}
              <div class="empty-state">
                <i class="bi bi-chat-left-dots"></i>
                <p>Nenhuma pergunta respondida ainda</p>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Dados dos convênios
const allConvenios = [
    {% for convenio in convenios %}
        {id: {{ convenio.id }}, nome: "{{ convenio.nome }}"},
    {% endfor %}
];

const userConvenios = [
    {% for convenio in clinica.convenios.all %}
        {id: {{ convenio.id }}, nome: "{{ convenio.nome }}"},
    {% endfor %}
];

let selectedConvenios = userConvenios.map(c => c.id);

// Dados dos idiomas
const allIdiomas = [
    {% for idioma in idiomas %}
        {id: {{ idioma.id }}, nome: "{{ idioma.nome }}"},
    {% endfor %}
];

const userIdiomas = [
    {% for idioma in clinica.idiomas.all %}
        {id: {{ idioma.id }}, nome: "{{ idioma.nome }}"},
    {% endfor %}
];

let selectedIdiomas = userIdiomas.map(i => i.id);

// Dados dos serviços
const allServicos = [
    {% for servico in servicos %}
        {id: {{ servico.id }}, nome: "{{ servico.nome }}"},
    {% endfor %}
];

const userServicos = [
    {% for servico in clinica.servicos.all %}
        {id: {{ servico.id }}, nome: "{{ servico.nome }}"},
    {% endfor %}
];

let selectedServicos = userServicos.map(s => s.id);

// Função para alternar conteúdo
function alterarConteudo(conteudoId) {
    // Remove classe active de todas as abas
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Esconde todos os conteúdos
    document.querySelectorAll('.conteudo').forEach(conteudo => {
        conteudo.classList.remove('active');
    });
    
    // Ativa a aba clicada
    event.target.classList.add('active');
    
    // Mostra o conteúdo correspondente
    const targetContent = document.getElementById(conteudoId);
    if (targetContent) {
        targetContent.classList.add('active');
    }
}

// Funções para Tags (Convênios, Idiomas, Serviços)
function createTagElement(container, itemArray, selectedArray, name, id) {
    const item = itemArray.find(i => i.id === id);
    if (!item) return;
    
    const tagElement = document.createElement('span');
    tagElement.className = 'tag-item';
    tagElement.innerHTML = `
        ${item.nome}
        <button type="button" class="tag-remove" onclick="removeTagElement(this, ${id}, '${container}', selectedConvenios)">×</button>
        <input type="hidden" name="${name}" value="${id}">
    `;
    
    document.getElementById(container).appendChild(tagElement);
}

function removeTagElement(button, id, containerName, selectedArray) {
    const index = selectedArray.indexOf(id);
    if (index > -1) {
        selectedArray.splice(index, 1);
        button.parentElement.remove();
    }
    updateAddButtonVisibility(containerName, selectedArray);
}

function updateAddButtonVisibility(containerName, selectedArray) {
    let allArray, buttonId;
    
    if (containerName === 'conveniosContainer') {
        allArray = allConvenios;
        buttonId = 'addConvenio';
    } else if (containerName === 'idiomasContainer') {
        allArray = allIdiomas;
        buttonId = 'addIdioma';
    } else if (containerName === 'servicosContainer') {
        allArray = allServicos;
        buttonId = 'addServico';
    }
    
    const addButton = document.getElementById(buttonId);
    const available = allArray.filter(item => !selectedArray.includes(item.id));
    addButton.style.display = available.length === 0 ? 'none' : 'inline-block';
}

// Convênios
function createConvenioElement(id) {
    const convenio = allConvenios.find(c => c.id === id);
    if (!convenio) return;
    
    const tagElement = document.createElement('span');
    tagElement.className = 'tag-item';
    tagElement.innerHTML = `
        ${convenio.nome}
        <button type="button" class="tag-remove" onclick="removeConvenio(this, ${id})">×</button>
        <input type="hidden" name="convenios" value="${id}">
    `;
    
    document.getElementById('conveniosContainer').appendChild(tagElement);
}

function removeConvenio(button, id) {
    const index = selectedConvenios.indexOf(id);
    if (index > -1) {
        selectedConvenios.splice(index, 1);
        button.parentElement.remove();
    }
    updateAddConvenioButtonVisibility();
}

function updateAddConvenioButtonVisibility() {
    const addButton = document.getElementById('addConvenio');
    const available = allConvenios.filter(c => !selectedConvenios.includes(c.id));
    addButton.style.display = available.length === 0 ? 'none' : 'inline-block';
}

// Idiomas
function createIdiomaElement(id) {
    const idioma = allIdiomas.find(i => i.id === id);
    if (!idioma) return;
    
    const tagElement = document.createElement('span');
    tagElement.className = 'tag-item';
    tagElement.innerHTML = `
        ${idioma.nome}
        <button type="button" class="tag-remove" onclick="removeIdioma(this, ${id})">×</button>
        <input type="hidden" name="idiomas" value="${id}">
    `;
    
    document.getElementById('idiomasContainer').appendChild(tagElement);
}

function removeIdioma(button, id) {
    const index = selectedIdiomas.indexOf(id);
    if (index > -1) {
        selectedIdiomas.splice(index, 1);
        button.parentElement.remove();
    }
    updateAddIdiomaButtonVisibility();
}

function updateAddIdiomaButtonVisibility() {
    const addButton = document.getElementById('addIdioma');
    const available = allIdiomas.filter(i => !selectedIdiomas.includes(i.id));
    addButton.style.display = available.length === 0 ? 'none' : 'inline-block';
}

// Serviços
function createServicoElement(id) {
    const servico = allServicos.find(s => s.id === id);
    if (!servico) return;
    
    const tagElement = document.createElement('span');
    tagElement.className = 'tag-item';
    tagElement.innerHTML = `
        ${servico.nome}
        <button type="button" class="tag-remove" onclick="removeServico(this, ${id})">×</button>
        <input type="hidden" name="servicos" value="${id}">
    `;
    
    document.getElementById('servicosContainer').appendChild(tagElement);
}

function removeServico(button, id) {
    const index = selectedServicos.indexOf(id);
    if (index > -1) {
        selectedServicos.splice(index, 1);
        button.parentElement.remove();
    }
    updateAddServicoButtonVisibility();
}

function updateAddServicoButtonVisibility() {
    const addButton = document.getElementById('addServico');
    const available = allServicos.filter(s => !selectedServicos.includes(s.id));
    addButton.style.display = available.length === 0 ? 'none' : 'inline-block';
}

// Event Listeners para adicionar tags
function setupTagAdders() {
    // Convênios
    const addConvenioBtn = document.getElementById('addConvenio');
    if (addConvenioBtn) {
        addConvenioBtn.addEventListener('click', function() {
            const available = allConvenios.filter(c => !selectedConvenios.includes(c.id));
            if (available.length === 0) return;
            
            showAddForm('conveniosContainer', available, function(selectedId) {
                selectedConvenios.push(selectedId);
                createConvenioElement(selectedId);
                updateAddConvenioButtonVisibility();
            });
        });
    }
    
    // Idiomas
    const addIdiomaBtn = document.getElementById('addIdioma');
    if (addIdiomaBtn) {
        addIdiomaBtn.addEventListener('click', function() {
            const available = allIdiomas.filter(i => !selectedIdiomas.includes(i.id));
            if (available.length === 0) return;
            
            showAddForm('idiomasContainer', available, function(selectedId) {
                selectedIdiomas.push(selectedId);
                createIdiomaElement(selectedId);
                updateAddIdiomaButtonVisibility();
            });
        });
    }
    
    // Serviços
    const addServicoBtn = document.getElementById('addServico');
    if (addServicoBtn) {
        addServicoBtn.addEventListener('click', function() {
            const available = allServicos.filter(s => !selectedServicos.includes(s.id));
            if (available.length === 0) return;
            
            showAddForm('servicosContainer', available, function(selectedId) {
                selectedServicos.push(selectedId);
                createServicoElement(selectedId);
                updateAddServicoButtonVisibility();
            });
        });
    }
}

function showAddForm(containerId, availableItems, onAdd) {
    const container = document.getElementById(containerId);
    
    // Remove formulário existente se houver
    const existingForm = container.querySelector('.add-form-container');
    if (existingForm) {
        existingForm.remove();
    }
    
    // Cria o formulário
    const formContainer = document.createElement('div');
    formContainer.className = 'add-form-container';
    
    const select = document.createElement('select');
    select.className = 'add-form-select';
    
    availableItems.forEach(item => {
        const option = document.createElement('option');
        option.value = item.id;
        option.textContent = item.nome;
        select.appendChild(option);
    });
    
    const addButton = document.createElement('button');
    addButton.type = 'button';
    addButton.className = 'add-form-button';
    addButton.textContent = 'Adicionar';
    addButton.addEventListener('click', function() {
        const selectedId = parseInt(select.value);
        onAdd(selectedId);
        formContainer.remove();
    });
    
    const cancelButton = document.createElement('button');
    cancelButton.type = 'button';
    cancelButton.className = 'btn-secondary btn-small';
    cancelButton.textContent = 'Cancelar';
    cancelButton.addEventListener('click', function() {
        formContainer.remove();
    });
    
    formContainer.appendChild(select);
    formContainer.appendChild(addButton);
    formContainer.appendChild(cancelButton);
    container.appendChild(formContainer);
}

// Funções para endereços
function setupEnderecos() {
    // Esta função será substituída por initEnderecoManagement
}

// Funções para gerenciamento de endereços
function initEnderecoManagement() {
    const addEnderecoBtn = document.getElementById('addEnderecoBtn');
    const enderecoForm = document.getElementById('enderecoForm');
    const cancelarEndereco = document.getElementById('cancelarEndereco');
    const cepInput = document.getElementById('cep');
    const formEndereco = document.getElementById('formEndereco');
    
    if (!addEnderecoBtn) return; // Se não estiver na página de endereços, sair
    
    // Máscara para CEP
    cepInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        value = value.replace(/^(\d{5})(\d)/, '$1-$2');
        e.target.value = value;
        
        // Se CEP completo, buscar endereço
        if (value.length === 9) {
            buscarEnderecoPorCEP(value);
        } else {
            limparCamposEndereco();
        }
    });
    
    // Mostrar formulário de adicionar
    addEnderecoBtn.addEventListener('click', function() {
        mostrarFormularioEndereco('Adicionar Endereço');
        limparFormularioEndereco();
    });
    
    // Cancelar edição/adição
    cancelarEndereco.addEventListener('click', function() {
        esconderFormularioEndereco();
    });
    
    // Submit do formulário
    formEndereco.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const cep = document.getElementById('cep').value;
        const cepLimpo = cep.replace(/\D/g, '');
        if (cepLimpo.length !== 8) {
            mostrarErro('CEP deve ter 8 dígitos');
            return;
        }
        
        if (!document.getElementById('rua').value || 
            !document.getElementById('bairro').value || 
            !document.getElementById('cidade').value) {
            mostrarErro('CEP inválido ou campos obrigatórios não preenchidos');
            return;
        }
        
        // Submit do formulário
        this.submit();
    });
}

function buscarEnderecoPorCEP(cep) {
    const cepLimpo = cep.replace(/\D/g, '');
    const cepError = document.getElementById('cepError');
    const ruaInput = document.getElementById('rua');
    const bairroInput = document.getElementById('bairro');
    const cidadeInput = document.getElementById('cidade');
    const estadoInput = document.getElementById('estado');
    
    if (cepLimpo.length !== 8) {
        limparCamposEndereco();
        return;
    }
    
    // Mostrar loading
    ruaInput.value = 'Buscando...';
    bairroInput.value = 'Buscando...';
    cidadeInput.value = 'Buscando...';
    estadoInput.value = 'Buscando...';
    cepError.style.display = 'none';
    
    fetch(`https://viacep.com.br/ws/${cepLimpo}/json/`)
        .then(response => response.json())
        .then(data => {
            if (data.erro) {
                throw new Error('CEP não encontrado');
            }
            
            ruaInput.value = data.logradouro || '';
            bairroInput.value = data.bairro || '';
            cidadeInput.value = data.localidade || '';
            estadoInput.value = data.uf || '';
            
        })
        .catch(error => {
            console.error('Erro ao buscar CEP:', error);
            mostrarErro('CEP não encontrado ou inválido');
            limparCamposEndereco();
        });
}

function limparCamposEndereco() {
    // Só limpar cidade e estado, permitindo que logradouro e bairro sejam editados manualmente
    document.getElementById('cidade').value = '';
    document.getElementById('estado').value = '';
}

function mostrarFormularioEndereco(titulo) {
    document.getElementById('enderecoFormTitle').textContent = titulo;
    document.getElementById('enderecoForm').style.display = 'block';
    document.getElementById('cep').focus();
}

function esconderFormularioEndereco() {
    document.getElementById('enderecoForm').style.display = 'none';
    limparFormularioEndereco();
}

function limparFormularioEndereco() {
    document.getElementById('formEndereco').reset();
    document.getElementById('enderecoId').value = '';
    document.getElementById('saveEnderecoText').textContent = 'Salvar Endereço';
    // Limpar todos os campos ao resetar o formulário
    document.getElementById('rua').value = '';
    document.getElementById('bairro').value = '';
    document.getElementById('cidade').value = '';
    document.getElementById('estado').value = '';
    document.getElementById('cepError').style.display = 'none';
}

function editarEndereco(enderecoId) {
    // Buscar o elemento do endereço para obter os dados
    const enderecoElement = document.querySelector(`[data-id="${enderecoId}"]`);
    
    if (enderecoElement) {
        // Preencher formulário com dados do endereço
        document.getElementById('enderecoId').value = enderecoId;
        document.getElementById('cep').value = enderecoElement.dataset.cep;
        document.getElementById('rua').value = enderecoElement.dataset.rua;
        document.getElementById('numero').value = enderecoElement.dataset.numero || '';
        document.getElementById('complemento').value = enderecoElement.dataset.complemento || '';
        document.getElementById('bairro').value = enderecoElement.dataset.bairro;
        document.getElementById('cidade').value = enderecoElement.dataset.cidade;
        document.getElementById('estado').value = enderecoElement.dataset.estado;
        
        mostrarFormularioEndereco('Editar Endereço');
        document.getElementById('saveEnderecoText').textContent = 'Atualizar Endereço';
    } else {
        mostrarErro('Endereço não encontrado');
    }
}

function removerEndereco(enderecoId) {
    // Buscar dados do endereço para mostrar no modal
    const enderecoElement = document.querySelector(`[data-id="${enderecoId}"]`);
    
    if (enderecoElement) {
        const rua = enderecoElement.dataset.rua;
        const numero = enderecoElement.dataset.numero;
        const bairro = enderecoElement.dataset.bairro;
        const cidade = enderecoElement.dataset.cidade;
        const estado = enderecoElement.dataset.estado;
        const cep = enderecoElement.dataset.cep;
        const complemento = enderecoElement.dataset.complemento;
        
        // Atualizar preview do endereço no modal
        const addressPreview = document.getElementById('addressPreview');
        addressPreview.innerHTML = `
            <h6>${rua}${numero ? ', ' + numero : ''}</h6>
            <p>${bairro}, ${cidade} - ${estado}</p>
            <p>CEP: ${cep}${complemento ? ' - ' + complemento : ''}</p>
        `;
        
        // Mostrar modal de confirmação
        const confirmModal = document.getElementById('confirmDeleteAddressModal');
        confirmModal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        // Configurar botão de confirmação
        const confirmBtn = document.getElementById('confirmDeleteAddress');
        const cancelBtn = document.getElementById('cancelDeleteAddress');
        
        // Remover event listeners anteriores
        const newConfirmBtn = confirmBtn.cloneNode(true);
        const newCancelBtn = cancelBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
        
        // Adicionar novos event listeners
        newConfirmBtn.addEventListener('click', function() {
            executeRemoveAddress(enderecoId);
        });
        
        newCancelBtn.addEventListener('click', function() {
            closeDeleteModal();
        });
        
        // Fechar modal com ESC
        document.addEventListener('keydown', handleEscKey);
        
        // Fechar modal clicando fora
        confirmModal.addEventListener('click', handleOutsideClick);
    }
}

function executeRemoveAddress(enderecoId) {
    console.log('Removendo endereço:', enderecoId); // Debug
    
    // Criar formulário temporário para remoção
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "alterar_Clinica" %}'; // URL da clínica
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    form.innerHTML = `
        <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
        <input type="hidden" name="action" value="remove_address">
        <input type="hidden" name="endereco_id" value="${enderecoId}">
    `;
    
    document.body.appendChild(form);
    form.submit();
}

function closeDeleteModal() {
    const confirmModal = document.getElementById('confirmDeleteAddressModal');
    confirmModal.style.display = 'none';
    document.body.style.overflow = 'auto';
    
    // Remover event listeners
    document.removeEventListener('keydown', handleEscKey);
    confirmModal.removeEventListener('click', handleOutsideClick);
}

function handleEscKey(e) {
    if (e.key === 'Escape') {
        closeDeleteModal();
    }
}

function handleOutsideClick(e) {
    const confirmModal = document.getElementById('confirmDeleteAddressModal');
    if (e.target === confirmModal) {
        closeDeleteModal();
    }
}

function mostrarErro(mensagem) {
    const cepError = document.getElementById('cepError');
    if (cepError) {
        cepError.textContent = mensagem;
        cepError.style.display = 'block';
        
        setTimeout(() => {
            cepError.style.display = 'none';
        }, 5000);
    }
}

// Script para assinatura
{% if clinica.is_active == False %}
function setupSubscription() {
    const checkoutBtn = document.getElementById('checkout-button');
    if (checkoutBtn) {
        checkoutBtn.addEventListener('click', function() {
            fetch('https://saudebras.com.br/create-subscription/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to create subscription');
                }
                return response.json();
            })
            .then((session) => {
                window.location.href = session.url;
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('Erro ao processar assinatura. Tente novamente.');
            });
        });
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
{% endif %}

// Funcionalidade de edição de foto
function setupPhotoEdit() {
    const inputFoto = document.getElementById('inputFoto');
    const previewContainer = document.getElementById('preview-container');
    const previewImage = document.getElementById('preview-image');
    const btnSalvar = document.getElementById('btnSalvarFoto');
    const errorMessage = document.getElementById('error-message');
    
    if (inputFoto) {
        inputFoto.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Validação do arquivo
                if (!file.type.startsWith('image/')) {
                    showError('Por favor, selecione apenas arquivos de imagem.');
                    return;
                }
                
                if (file.size > 5 * 1024 * 1024) { // 5MB
                    showError('A imagem deve ter no máximo 5MB.');
                    return;
                }
                
                // Mostra preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    previewContainer.style.display = 'block';
                    btnSalvar.disabled = false;
                    hideError();
                };
                reader.readAsDataURL(file);
            }
        });
    }
    
    if (btnSalvar) {
        btnSalvar.addEventListener('click', function() {
            const form = document.getElementById('formEditarFoto');
            if (form) {
                form.submit();
            }
        });
    }
    
    function showError(message) {
        if (errorMessage) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }
        btnSalvar.disabled = true;
        previewContainer.style.display = 'none';
    }
    
    function hideError() {
        if (errorMessage) {
            errorMessage.style.display = 'none';
        }
    }
}

// Inicialização
document.addEventListener('DOMContentLoaded', function() {
    // Inicializa tags existentes
    userConvenios.forEach(c => createConvenioElement(c.id));
    userIdiomas.forEach(i => createIdiomaElement(i.id));
    userServicos.forEach(s => createServicoElement(s.id));
    
    // Atualiza visibilidade dos botões
    updateAddConvenioButtonVisibility();
    updateAddIdiomaButtonVisibility();
    updateAddServicoButtonVisibility();
    
    // Configura event listeners
    setupTagAdders();
    initEnderecoManagement(); // Substituído setupEnderecos por initEnderecoManagement
    setupPhotoEdit();
    
    {% if clinica.is_active == False %}
    setupSubscription();
    {% endif %}
    
    // Auto-hide messages after 3 seconds
    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(function(alert) {
        setTimeout(function() {
            if (alert && alert.parentNode) {
                // Fade out animation
                alert.style.transition = 'opacity 0.5s ease-out';
                alert.style.opacity = '0';
                
                // Remove from DOM after fade out
                setTimeout(function() {
                    if (alert && alert.parentNode) {
                        alert.parentNode.removeChild(alert);
                    }
                }, 500);
            }
        }, 3000); // 3 seconds
    });
});
</script>

{% endblock %}
